<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∏ÖÈÇÅÊîæÁ©∫Âúò - Ë®òÂ∏≥ÁÆ°ÁêÜÁ≥ªÁµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .btn {
            transition: all 0.2s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .card {
            transition: all 0.3s;
        }
        .card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-yellow-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-orange-600 mb-2">üèõÔ∏è Ê∏ÖÈÇÅÊîæÁ©∫Âúò üõ∫</h1>
                <p class="text-gray-600">Ë®òÂ∏≥ÁÆ°ÁêÜÁ≥ªÁµ±</p>
            </div>

            <!-- ÂúòÂì°ÁÆ°ÁêÜ -->
            <div class="mb-8 bg-orange-50 rounded-lg p-6 card">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="icon text-orange-600" viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h2 class="text-2xl font-bold text-orange-800">ÂúòÂì°ÁÆ°ÁêÜ (6‰∫∫)</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="friendsGrid">
                    <!-- ÂãïÊÖãÁîüÊàê -->
                </div>
                
                <div class="mt-4 text-sm text-gray-600" id="friendsStatus">
                    Â∑≤Â°´ÂØ´ÂúòÂì°: 0/6 ‰∫∫
                </div>
            </div>

            <!-- ÂÖ¨Ë≤ªÁÆ°ÁêÜ -->
            <div class="mb-8 bg-green-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-green-600" viewBox="0 0 24 24">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <path d="m16 8 2 0 0 8-2 0"></path>
                            <path d="m4 8 0-1c0-.6.4-1 1-1h4c.6 0 1 .4 1 1v1"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-green-800">ÂÖ¨Ë≤ªÁÆ°ÁêÜ</h2>
                    </div>
                    <button onclick="toggleAddFunds()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2 btn" id="addFundsBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        Êî∂ÂèñÂÖ¨Ë≤ª
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">ÂÖ¨Ë≤ªÈ§òÈ°ç</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">Âè∞Âπ£È§òÈ°ç</div>
                            <div class="text-2xl font-bold text-green-600" id="twdBalance">TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">Ê≥∞ÈäñÈ§òÈ°ç</div>
                            <div class="text-2xl font-bold text-green-600" id="thbBalance">THB 0.00</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">ÊØè‰∫∫Â∑≤Áπ≥ÂÖ¨Ë≤ª</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">Âè∞Âπ£ (ÊØè‰∫∫)</div>
                            <div class="text-xl font-bold text-blue-600" id="twdContribution">TWD 0.00</div>
                            <div class="text-xs text-gray-500" id="twdTotal">Á∏ΩË®à: TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">Ê≥∞Èäñ (ÊØè‰∫∫)</div>
                            <div class="text-xl font-bold text-blue-600" id="thbContribution">THB 0.00</div>
                            <div class="text-xs text-gray-500" id="thbTotal">Á∏ΩË®à: THB 0.00</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-green-200 hidden" id="addFundsForm">
                    <h3 class="font-semibold text-green-800 mb-3">Êî∂ÂèñÂÖ¨Ë≤ª (<span id="fundsPersonCount">0</span> ‰∫∫)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊØè‰∫∫ÈáëÈ°çË®àÁÆó</label>
                            <input type="text" id="fundCalc" placeholder="‰æã: 100*5+50" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" oninput="updateFundCalc()">
                            <div class="text-xs text-gray-500 mt-1">ÊØè‰∫∫: <span id="fundCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊàñÁõ¥Êé•Ëº∏ÂÖ•ÊØè‰∫∫ÈáëÈ°ç</label>
                            <input type="number" id="fundAmount" placeholder="ÊØè‰∫∫ÈáëÈ°ç" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âπ£Âà•</label>
                            <select id="fundCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="THB">Ê≥∞Èäñ (THB)</option>
                                <option value="TWD">Âè∞Âπ£ (TWD)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-gray-50 rounded text-sm" id="fundPreview">
                        <strong>È†êË¶Ω:</strong> ÊØè‰∫∫Áπ≥‰∫§ 0 THBÔºåÁ∏ΩË®àÊî∂ÂÖ• 0 THB
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="addPublicFund()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn">Êî∂ÂèñÂÖ¨Ë≤ª</button>
                        <button onclick="toggleAddFunds()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">ÂèñÊ∂à</button>
                    </div>
                </div>
            </div>

            <!-- ÊîØÂá∫ÁÆ°ÁêÜ -->
            <div class="mb-8 bg-blue-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-blue-600" viewBox="0 0 24 24">
                            <path d="M12 1v22"></path>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-blue-800">ÊîØÂá∫Ë®òÈåÑ</h2>
                    </div>
                    <button onclick="toggleAddExpense()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 btn" id="addExpenseBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        Êñ∞Â¢ûÊîØÂá∫
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg border border-blue-200 mb-4 hidden" id="addExpenseForm">
                    <h3 class="font-semibold text-blue-800 mb-3" id="expenseFormTitle">Êñ∞Â¢ûÊîØÂá∫</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊîØÂá∫ÊèèËø∞</label>
                            <input type="text" id="expenseDesc" placeholder="‰æã: ÊôöÈ§êË≤ªÁî®" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Êó•Êúü</label>
                            <input type="date" id="expenseDate" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÈáëÈ°çË®àÁÆó</label>
                            <input type="text" id="expenseCalc" placeholder="‰æã: 200*3+150" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="updateExpenseCalc()">
                            <div class="text-xs text-gray-500 mt-1">Ë®àÁÆóÁµêÊûú: <span id="expenseCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÊàñÁõ¥Êé•Ëº∏ÂÖ•ÈáëÈ°ç</label>
                            <input type="number" id="expenseAmount" placeholder="ÈáëÈ°ç" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Âπ£Âà•</label>
                            <select id="expenseCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="THB">Ê≥∞Èäñ (THB)</option>
                                <option value="TWD">Âè∞Âπ£ (TWD)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‰ªòÊ¨æÊñπÂºè</label>
                            <select id="expensePaidBy" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="public">ÂÖ¨Ë≤ªÊîØ‰ªò</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‰ΩøÁî®‰∫∫Âì°</label>
                            <div class="flex flex-wrap gap-2" id="usedByButtons">
                                <!-- ÂãïÊÖãÁîüÊàê -->
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="addExpense()" class="px-4 py-2 bg-blue-500 text-white rounded btn" id="expenseSubmitBtn">Êñ∞Â¢ûÊîØÂá∫</button>
                        <button onclick="cancelExpenseEdit()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">ÂèñÊ∂à</button>
                    </div>
                </div>

                <!-- ÊîØÂá∫ÂàóË°® -->
                <div class="space-y-3" id="expensesList">
                    <!-- ÂãïÊÖãÁîüÊàê -->
                </div>
            </div>

            <!-- ÊúÄÁµÇÁµêÁÆó -->
            <div class="bg-purple-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-purple-600" viewBox="0 0 24 24">
                            <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                            <rect x="9" y="9" width="1" height="1"></rect>
                            <rect x="14" y="9" width="1" height="1"></rect>
                            <rect x="9" y="14" width="1" height="1"></rect>
                            <rect x="14" y="14" width="1" height="1"></rect>
                        </svg>
                        <h2 class="text-2xl font-bold text-purple-800">ÊúÄÁµÇÁµêÁÆó</h2>
                    </div>
                    <button onclick="toggleSettlement()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 btn" id="settlementBtn">È°ØÁ§∫ ÁµêÁÆó</button>
                </div>

                <div class="space-y-4 hidden" id="settlementContent">
                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">ÊúÄÁµÇÁµêÁÆóÊòéÁ¥∞ (Â∑≤Âê´Â∑≤Áπ≥ÂÖ¨Ë≤ª)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="settlementGrid">
                            <!-- ÂãïÊÖãÁîüÊàê -->
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">Ë™™Êòé</h3>
                        <div class="text-sm text-gray-600 space-y-2">
                            <p>‚Ä¢ <strong>üí∞ Á∂†Ëâ≤Êï∏Â≠ó</strong>ÔºöË°®Á§∫Ê≠§‰∫∫ÊáâÊî∂ÂõûÁöÑÈáëÈ°çÔºàÂ∑≤‰ªòË∂ÖÈÅéÊáâ‰ªòÔºâ</p>
                            <p>‚Ä¢ <strong>üí∏ Á¥ÖËâ≤Êï∏Â≠ó</strong>ÔºöË°®Á§∫Ê≠§‰∫∫ÈúÄË£úÁπ≥ÁöÑÈáëÈ°çÔºàÊáâ‰ªòË∂ÖÈÅéÂ∑≤‰ªòÔºâ</p>
                            <p>‚Ä¢ Ë®àÁÆóÂ∑≤ÂåÖÂê´ÊØè‰∫∫Â∑≤Áπ≥‰∫§ÁöÑÂÖ¨Ë≤ªÈáëÈ°ç</p>
                            <p>‚Ä¢ ÂåØÁéá: 1 TWD = 1.1 THB</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let friends = ['', '', '', '', '', ''];
        let publicFunds = { TWD: 0, THB: 0 };
        let publicContributions = { TWD: 0, THB: 0 };
        let expenses = [];
        let editingExpenseId = null;
        let usedBySelection = [];
        const exchangeRate = 1.1;

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            renderFriends();
            updateExpenseDate();
            updateDisplay();
        });

        // Ë®àÁÆóÂáΩÊï∏
        function calculateAmount(input) {
            try {
                return Function('"use strict"; return (' + input + ')')() || 0;
            } catch (e) {
                return 0;
            }
        }

        // Áç≤ÂèñÊúâÊïàÊúãÂèã
        function getValidFriends() {
            return friends.filter(f => f.trim() !== '');
        }

        // Ê∏≤ÊüìÊúãÂèãÂàóË°®
        function renderFriends() {
            const grid = document.getElementById('friendsGrid');
            grid.innerHTML = '';
            
            friends.forEach((friend, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <span class="text-sm text-gray-600 w-8">#${index + 1}</span>
                    <input type="text" value="${friend}" onchange="updateFriend(${index}, this.value)" 
                           placeholder="ÂúòÂì° ${index + 1} ÂßìÂêç" 
                           class="flex-1 p-3 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                `;
                grid.appendChild(div);
            });
            
            updateFriendsStatus();
            updateExpenseOptions();
        }

        // Êõ¥Êñ∞ÊúãÂèã
        function updateFriend(index, value) {
            friends[index] = value;
            updateFriendsStatus();
            updateExpenseOptions();
        }

        // Êõ¥Êñ∞ÊúãÂèãÁãÄÊÖã
        function updateFriendsStatus() {
            const validFriends = getValidFriends();
            document.getElementById('friendsStatus').innerHTML = 
                `Â∑≤Â°´ÂØ´ÂúòÂì°: ${validFriends.length}/6 ‰∫∫${validFriends.length > 0 ? ` (${validFriends.join(', ')})` : ''}`;
        }

        // Êõ¥Êñ∞ÊîØÂá∫ÈÅ∏È†Ö
        function updateExpenseOptions() {
            const validFriends = getValidFriends();
            const paidBySelect = document.getElementById('expensePaidBy');
            const usedByDiv = document.getElementById('usedByButtons');
            
            // Êõ¥Êñ∞‰ªòÊ¨æÊñπÂºè
            paidBySelect.innerHTML = '<option value="public">ÂÖ¨Ë≤ªÊîØ‰ªò</option>';
            validFriends.forEach(friend => {
                paidBySelect.innerHTML += `<option value="${friend}">${friend} ÂÄã‰∫∫ÊîØ‰ªò</option>`;
            });
            
            // Êõ¥Êñ∞‰ΩøÁî®‰∫∫Âì°
            usedByDiv.innerHTML = '';
            validFriends.forEach(friend => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `px-3 py-1 rounded-full text-sm ${
                    usedBySelection.includes(friend) 
                        ? 'bg-blue-500 text-white' 
                        : 'bg-gray-200 text-gray-700'
                }`;
                button.textContent = friend;
                button.onclick = () => toggleUsedBy(friend);
                usedByDiv.appendChild(button);
            });
            
            document.getElementById('fundsPersonCount').textContent = validFriends.length;
            
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            const hasValidFriends = validFriends.length > 0;
            document.getElementById('addFundsBtn').disabled = !hasValidFriends;
            document.getElementById('addExpenseBtn').disabled = !hasValidFriends;
        }

        // ÂàáÊèõ‰ΩøÁî®‰∫∫Âì°
        function toggleUsedBy(friend) {
            const index = usedBySelection.indexOf(friend);
            if (index > -1) {
                usedBySelection.splice(index, 1);
            } else {
                usedBySelection.push(friend);
            }
            updateExpenseOptions();
        }

        // Êõ¥Êñ∞ÂÖ¨Ë≤ªË®àÁÆó
        function updateFundCalc() {
            const input = document.getElementById('fundCalc').value;
            const result = calculateAmount(input);
            document.getElementById('fundCalcResult').textContent = result;
            updateFundPreview();
        }

        // Êõ¥Êñ∞ÂÖ¨Ë≤ªÈ†êË¶Ω
        function updateFundPreview() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
            const totalAmount = perPersonAmount * validFriends.length;
            
            document.getElementById('fundPreview').innerHTML = 
                `<strong>È†êË¶Ω:</strong> ÊØè‰∫∫Áπ≥‰∫§ ${perPersonAmount} ${currency}ÔºåÁ∏ΩË®àÊî∂ÂÖ• ${totalAmount} ${currency}`;
        }

        // Êõ¥Êñ∞ÊîØÂá∫Ë®àÁÆó
        function updateExpenseCalc() {
            const input = document.getElementById('expenseCalc').value;
            const result = calculateAmount(input);
            document.getElementById('expenseCalcResult').textContent = result;
        }

        // Êõ¥Êñ∞ÊîØÂá∫Êó•Êúü
        function updateExpenseDate() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        // ÂàáÊèõÂÖ¨Ë≤ªË°®ÂñÆ
        function toggleAddFunds() {
            const form = document.getElementById('addFundsForm');
            const isHidden = form.classList.contains('hidden');
            
            if (isHidden) {
                form.classList.remove('hidden');
                updateFundPreview();
            } else {
                form.classList.add('hidden');
                // Ê∏ÖÁ©∫Ë°®ÂñÆ
                document.getElementById('fundCalc').value = '';
                document.getElementById('fundAmount').value = '';
                document.getElementById('fundCurrency').value = 'THB';
            }
        }

        // Êñ∞Â¢ûÂÖ¨Ë≤ª
        function addPublicFund() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
            const totalAmount = perPersonAmount * validFriends.length;
            
            if (perPersonAmount > 0 && validFriends.length > 0) {
                publicFunds[currency] += totalAmount;
                publicContributions[currency] += perPersonAmount;
                
                updateDisplay();
                toggleAddFunds();
            }
        }

        // ÂàáÊèõÊîØÂá∫Ë°®ÂñÆ
        function toggleAddExpense() {
            const form = document.getElementById('addExpenseForm');
            const isHidden = form.classList.contains('hidden');
            
            if (isHidden) {
                form.classList.remove('hidden');
                // È†êË®≠ÂÖ®ÈÅ∏ÊâÄÊúâ‰∫∫
                usedBySelection = [...getValidFriends()];
                updateExpenseOptions();
                updateExpenseDate();
            } else {
                form.classList.add('hidden');
                cancelExpenseEdit();
            }
        }

        // ÂèñÊ∂àÊîØÂá∫Á∑®ËºØ
        function cancelExpenseEdit() {
            if (editingExpenseId !== null) {
                const originalExpense = expenses.find(e => e.id === editingExpenseId);
                if (originalExpense && originalExpense.paidBy === 'public') {
                    publicFunds[originalExpense.currency] -= originalExpense.amount;
                }
            }
            
            editingExpenseId = null;
            usedBySelection = [];
            
            // Ê∏ÖÁ©∫Ë°®ÂñÆ
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseCalc').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCurrency').value = 'THB';
            document.getElementById('expensePaidBy').value = 'public';
            document.getElementById('expenseFormTitle').textContent = 'Êñ∞Â¢ûÊîØÂá∫';
            document.getElementById('expenseSubmitBtn').textContent = 'Êñ∞Â¢ûÊîØÂá∫';
            document.getElementById('expenseSubmitBtn').className = 'px-4 py-2 bg-blue-500 text-white rounded btn';
            
            updateExpenseOptions();
        }

        // Êñ∞Â¢ûÊîØÂá∫
        function addExpense() {
            const description = document.getElementById('expenseDesc').value;
            const calcInput = document.getElementById('expenseCalc').value;
            const directAmount = document.getElementById('expenseAmount').value;
            const currency = document.getElementById('expenseCurrency').value;
            const paidBy = document.getElementById('expensePaidBy').value;
            const date = document.getElementById('expenseDate').value;
            
            const amount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validUsedBy = usedBySelection.filter(f => getValidFriends().includes(f));
            
            if (description && amount > 0 && validUsedBy.length > 0) {
                if (editingExpenseId !== null) {
                    // Êõ¥Êñ∞ÊîØÂá∫
                    const expenseIndex = expenses.findIndex(e => e.id === editingExpenseId);
                    expenses[expenseIndex] = {
                        id: editingExpenseId,
                        description,
                        amount,
                        currency,
                        paidBy,
                        usedBy: validUsedBy,
                        date
                    };
                } else {
                    // Êñ∞Â¢ûÊîØÂá∫
                    expenses.push({
                        id: Date.now(),
                        description,
                        amount,
                        currency,
                        paidBy,
                        usedBy: validUsedBy,
                        date
                    });
                }
                
                // Â¶ÇÊûúÊòØÂÖ¨Ë≤ªÊîØ‰ªòÔºåÊâ£Èô§ÂÖ¨Ë≤ª
                if (paidBy === 'public') {
                    publicFunds[currency] -= amount;
                }
                
                updateDisplay();
                renderExpenses();
                toggleAddExpense();
            }
        }

        // Á∑®ËºØÊîØÂá∫
        function editExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;
            
            // Â¶ÇÊûúÂéüÊú¨ÊòØÂÖ¨Ë≤ªÊîØ‰ªòÔºåÂÖàÈÄÄÂõûÂÖ¨Ë≤ª
            if (expense.paidBy === 'public') {
                publicFunds[expense.currency] += expense.amount;
            }
            
            editingExpenseId = expenseId;
            usedBySelection = [...expense.usedBy];
            
            // Â°´ÂÖ•Ë°®ÂñÆ
            document.getElementById('expenseDesc').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseCurrency').value = expense.currency;
            document.getElementById('expensePaidBy').value = expense.paidBy;
            document.getElementById('expenseDate').value = expense.date;
            
            document.getElementById('expenseFormTitle').textContent = 'Á∑®ËºØÊîØÂá∫';
            document.getElementById('expenseSubmitBtn').textContent = 'Êõ¥Êñ∞ÊîØÂá∫';
            document.getElementById('expenseSubmitBtn').className = 'px-4 py-2 bg-orange-500 text-white rounded btn';
            
            document.getElementById('addExpenseForm').classList.remove('hidden');
            updateExpenseOptions();
        }

        // Âà™Èô§ÊîØÂá∫
        function removeExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (expense && expense.paidBy === 'public') {
                publicFunds[expense.currency] += expense.amount;
            }
            expenses = expenses.filter(e => e.id !== expenseId);
            
            updateDisplay();
            renderExpenses();
        }

        // Ê∏≤ÊüìÊîØÂá∫ÂàóË°®
        function renderExpenses() {
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            
            expenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg border border-blue-200';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-2">
                                <span class="font-semibold text-lg">${expense.description}</span>
                                <span class="text-blue-600 font-bold">${expense.currency} ${expense.amount.toFixed(2)}</span>
                                <span class="text-sm text-gray-500">${expense.date}</span>
                            </div>
