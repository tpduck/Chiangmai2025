<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…é‚æ”¾ç©ºåœ˜ - è¨˜å¸³ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .btn {
            transition: all 0.2s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .card {
            transition: all 0.3s;
        }
        .card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-yellow-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-orange-600 mb-2">ğŸ›ï¸ æ¸…é‚æ”¾ç©ºåœ˜ ğŸ›º</h1>
                <p class="text-gray-600">è¨˜å¸³ç®¡ç†ç³»çµ±</p>
            </div>

            <!-- åœ˜å“¡ç®¡ç† -->
            <div class="mb-8 bg-orange-50 rounded-lg p-6 card">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="icon text-orange-600" viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h2 class="text-2xl font-bold text-orange-800">åœ˜å“¡ç®¡ç† (6äºº)</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="friendsGrid">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div class="mt-4 text-sm text-gray-600" id="friendsStatus">
                    å·²å¡«å¯«åœ˜å“¡: 0/6 äºº
                </div>
            </div>

            <!-- å…¬è²»ç®¡ç† -->
            <div class="mb-8 bg-green-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-green-600" viewBox="0 0 24 24">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <path d="m16 8 2 0 0 8-2 0"></path>
                            <path d="m4 8 0-1c0-.6.4-1 1-1h4c.6 0 1 .4 1 1v1"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-green-800">å…¬è²»ç®¡ç†</h2>
                    </div>
                    <button onclick="toggleAddFunds()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2 btn" id="addFundsBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        æ”¶å–å…¬è²»
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">å…¬è²»é¤˜é¡</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">å°å¹£é¤˜é¡</div>
                            <div class="text-2xl font-bold text-green-600" id="twdBalance">TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">æ³°éŠ–é¤˜é¡</div>
                            <div class="text-2xl font-bold text-green-600" id="thbBalance">THB 0.00</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">æ¯äººå·²ç¹³å…¬è²»</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">å°å¹£ (æ¯äºº)</div>
                            <div class="text-xl font-bold text-blue-600" id="twdContribution">TWD 0.00</div>
                            <div class="text-xs text-gray-500" id="twdTotal">ç¸½è¨ˆ: TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">æ³°éŠ– (æ¯äºº)</div>
                            <div class="text-xl font-bold text-blue-600" id="thbContribution">THB 0.00</div>
                            <div class="text-xs text-gray-500" id="thbTotal">ç¸½è¨ˆ: THB 0.00</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-green-200 hidden" id="addFundsForm">
                    <h3 class="font-semibold text-green-800 mb-3">æ”¶å–å…¬è²» (<span id="fundsPersonCount">0</span> äºº)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ¯äººé‡‘é¡è¨ˆç®—</label>
                            <input type="text" id="fundCalc" placeholder="ä¾‹: 100*5+50" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500" oninput="updateFundCalc()">
                            <div class="text-xs text-gray-500 mt-1">æ¯äºº: <span id="fundCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æˆ–ç›´æ¥è¼¸å…¥æ¯äººé‡‘é¡</label>
                            <input type="number" id="fundAmount" placeholder="æ¯äººé‡‘é¡" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¹£åˆ¥</label>
                            <select id="fundCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="THB">æ³°éŠ– (THB)</option>
                                <option value="TWD">å°å¹£ (TWD)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-gray-50 rounded text-sm" id="fundPreview">
                        <strong>é è¦½:</strong> æ¯äººç¹³äº¤ 0 THBï¼Œç¸½è¨ˆæ”¶å…¥ 0 THB
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="addPublicFund()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn">æ”¶å–å…¬è²»</button>
                        <button onclick="toggleAddFunds()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ”¯å‡ºç®¡ç† -->
            <div class="mb-8 bg-blue-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-blue-600" viewBox="0 0 24 24">
                            <path d="M12 1v22"></path>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-blue-800">æ”¯å‡ºè¨˜éŒ„</h2>
                    </div>
                    <button onclick="toggleAddExpense()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 btn" id="addExpenseBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        æ–°å¢æ”¯å‡º
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg border border-blue-200 mb-4 hidden" id="addExpenseForm">
                    <h3 class="font-semibold text-blue-800 mb-3" id="expenseFormTitle">æ–°å¢æ”¯å‡º</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ”¯å‡ºæè¿°</label>
                            <input type="text" id="expenseDesc" placeholder="ä¾‹: æ™šé¤è²»ç”¨" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                            <input type="date" id="expenseDate" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é‡‘é¡è¨ˆç®—</label>
                            <input type="text" id="expenseCalc" placeholder="ä¾‹: 200*3+150" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="updateExpenseCalc()">
                            <div class="text-xs text-gray-500 mt-1">è¨ˆç®—çµæœ: <span id="expenseCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æˆ–ç›´æ¥è¼¸å…¥é‡‘é¡</label>
                            <input type="number" id="expenseAmount" placeholder="é‡‘é¡" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¹£åˆ¥</label>
                            <select id="expenseCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="THB">æ³°éŠ– (THB)</option>
                                <option value="TWD">å°å¹£ (TWD)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾æ–¹å¼</label>
                            <select id="expensePaidBy" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="public">å…¬è²»æ”¯ä»˜</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨äººå“¡</label>
                            <div class="flex flex-wrap gap-2" id="usedByButtons">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="addExpense()" class="px-4 py-2 bg-blue-500 text-white rounded btn" id="expenseSubmitBtn">æ–°å¢æ”¯å‡º</button>
                        <button onclick="cancelExpenseEdit()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">å–æ¶ˆ</button>
                    </div>
                </div>

                <!-- æ”¯å‡ºåˆ—è¡¨ -->
                <div class="space-y-3" id="expensesList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æœ€çµ‚çµç®— -->
            <div class="bg-purple-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-purple-600" viewBox="0 0 24 24">
                            <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                            <rect x="9" y="9" width="1" height="1"></rect>
                            <rect x="14" y="9" width="1" height="1"></rect>
                            <rect x="9" y="14" width="1" height="1"></rect>
                            <rect x="14" y="14" width="1" height="1"></rect>
                        </svg>
                        <h2 class="text-2xl font-bold text-purple-800">æœ€çµ‚çµç®—</h2>
                    </div>
                    <button onclick="toggleSettlement()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 btn" id="settlementBtn">é¡¯ç¤º çµç®—</button>
                </div>

                <div class="space-y-4 hidden" id="settlementContent">
                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">æœ€çµ‚çµç®—æ˜ç´° (å·²å«å·²ç¹³å…¬è²»)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="settlementGrid">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">èªªæ˜</h3>
                        <div class="text-sm text-gray-600 space-y-2">
                            <p>â€¢ <strong>ğŸ’° ç¶ è‰²æ•¸å­—</strong>ï¼šè¡¨ç¤ºæ­¤äººæ‡‰æ”¶å›çš„é‡‘é¡ï¼ˆå·²ä»˜è¶…éæ‡‰ä»˜ï¼‰</p>
                            <p>â€¢ <strong>ğŸ’¸ ç´…è‰²æ•¸å­—</strong>ï¼šè¡¨ç¤ºæ­¤äººéœ€è£œç¹³çš„é‡‘é¡ï¼ˆæ‡‰ä»˜è¶…éå·²ä»˜ï¼‰</p>
                            <p>â€¢ è¨ˆç®—å·²åŒ…å«æ¯äººå·²ç¹³äº¤çš„å…¬è²»é‡‘é¡</p>
                            <p>â€¢ åŒ¯ç‡: 1 TWD = 1.1 THB</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let friends = ['', '', '', '', '', ''];
        let publicFunds = { TWD: 0, THB: 0 };
        let publicContributions = { TWD: 0, THB: 0 };
        let expenses = [];
        let editingExpenseId = null;
        let usedBySelection = [];
        const exchangeRate = 1.1;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderFriends();
            updateExpenseDate();
            updateDisplay();
        });

        // è¨ˆç®—å‡½æ•¸
        function calculateAmount(input) {
            try {
                return Function('"use strict"; return (' + input + ')')() || 0;
            } catch (e) {
                return 0;
            }
        }

        // ç²å–æœ‰æ•ˆæœ‹å‹
        function getValidFriends() {
            return friends.filter(f => f.trim() !== '');
        }

        // æ¸²æŸ“æœ‹å‹åˆ—è¡¨
        function renderFriends() {
            const grid = document.getElementById('friendsGrid');
            grid.innerHTML = '';
            
            friends.forEach((friend, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <span class="text-sm text-gray-600 w-8">#${index + 1}</span>
                    <input type="text" value="${friend}" onchange="updateFriend(${index}, this.value)" 
                           placeholder="åœ˜å“¡ ${index + 1} å§“å" 
                           class="flex-1 p-3 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                `;
                grid.appendChild(div);
            });
            
            updateFriendsStatus();
            updateExpenseOptions();
        }

        // æ›´æ–°æœ‹å‹
        function updateFriend(index, value) {
            friends[index] = value;
            updateFriendsStatus();
            updateExpenseOptions();
        }

        // æ›´æ–°æœ‹å‹ç‹€æ…‹
        function updateFriendsStatus() {
            const validFriends = getValidFriends();
            document.getElementById('friendsStatus').innerHTML = 
                `å·²å¡«å¯«åœ˜å“¡: ${validFriends.length}/6 äºº${validFriends.length > 0 ? ` (${validFriends.join(', ')})` : ''}`;
        }

        // æ›´æ–°æ”¯å‡ºé¸é …
        function updateExpenseOptions() {
            const validFriends = getValidFriends();
            const paidBySelect = document.getElementById('expensePaidBy');
            const usedByDiv = document.getElementById('usedByButtons');
            
            // æ›´æ–°ä»˜æ¬¾æ–¹å¼
            paidBySelect.innerHTML = '<option value="public">å…¬è²»æ”¯ä»˜</option>';
            validFriends.forEach(friend => {
                paidBySelect.innerHTML += `<option value="${friend}">${friend} å€‹äººæ”¯ä»˜</option>`;
            });
            
            // æ›´æ–°ä½¿ç”¨äººå“¡
            usedByDiv.innerHTML = '';
            validFriends.forEach(friend => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `px-3 py-1 rounded-full text-sm ${
                    usedBySelection.includes(friend) 
                        ? 'bg-blue-500 text-white' 
                        : 'bg-gray-200 text-gray-700'
                }`;
                button.textContent = friend;
                button.onclick = () => toggleUsedBy(friend);
                usedByDiv.appendChild(button);
            });
            
            document.getElementById('fundsPersonCount').textContent = validFriends.length;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const hasValidFriends = validFriends.length > 0;
            document.getElementById('addFundsBtn').disabled = !hasValidFriends;
            document.getElementById('addExpenseBtn').disabled = !hasValidFriends;
        }

        // åˆ‡æ›ä½¿ç”¨äººå“¡
        function toggleUsedBy(friend) {
            const index = usedBySelection.indexOf(friend);
            if (index > -1) {
                usedBySelection.splice(index, 1);
            } else {
                usedBySelection.push(friend);
            }
            updateExpenseOptions();
        }

        // æ›´æ–°å…¬è²»è¨ˆç®—
        function updateFundCalc() {
            const input = document.getElementById('fundCalc').value;
            const result = calculateAmount(input);
            document.getElementById('fundCalcResult').textContent = result;
            updateFundPreview();
        }

        // æ›´æ–°å…¬è²»é è¦½
        function updateFundPreview() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
            const totalAmount = perPersonAmount * validFriends.length;
            
            document.getElementById('fundPreview').innerHTML = 
                `<strong>é è¦½:</strong> æ¯äººç¹³äº¤ ${perPersonAmount} ${currency}ï¼Œç¸½è¨ˆæ”¶å…¥ ${totalAmount} ${currency}`;
        }

        // æ›´æ–°æ”¯å‡ºè¨ˆç®—
        function updateExpenseCalc() {
            const input = document.getElementById('expenseCalc').value;
            const result = calculateAmount(input);
            document.getElementById('expenseCalcResult').textContent = result;
        }

        // æ›´æ–°æ”¯å‡ºæ—¥æœŸ
        function updateExpenseDate() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        // åˆ‡æ›å…¬è²»è¡¨å–®
        function toggleAddFunds() {
            const form = document.getElementById('addFundsForm');
            const isHidden = form.classList.contains('hidden');
            
            if (isHidden) {
                form.classList.remove('hidden');
                updateFundPreview();
            } else {
                form.classList.add('hidden');
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('fundCalc').value = '';
                document.getElementById('fundAmount').value = '';
                document.getElementById('fundCurrency').value = 'THB';
            }
        }

        // æ–°å¢å…¬è²»
        function addPublicFund() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
            const totalAmount = perPersonAmount * validFriends.length;
            
            if (perPersonAmount > 0 && validFriends.length > 0) {
                publicFunds[currency] += totalAmount;
                publicContributions[currency] += perPersonAmount;
                
                updateDisplay();
                toggleAddFunds();
            }
        }

        // åˆ‡æ›æ”¯å‡ºè¡¨å–®
        function toggleAddExpense() {
            const form = document.getElementById('addExpenseForm');
            const isHidden = form.classList.contains('hidden');
            
            if (isHidden) {
                form.classList.remove('hidden');
                // é è¨­å…¨é¸æ‰€æœ‰äºº
                usedBySelection = [...getValidFriends()];
                updateExpenseOptions();
                updateExpenseDate();
            } else {
                form.classList.add('hidden');
                cancelExpenseEdit();
            }
        }

        // å–æ¶ˆæ”¯å‡ºç·¨è¼¯
        function cancelExpenseEdit() {
            if (editingExpenseId !== null) {
                const originalExpense = expenses.find(e => e.id === editingExpenseId);
                if (originalExpense && originalExpense.paidBy === 'public') {
                    publicFunds[originalExpense.currency] -= originalExpense.amount;
                }
            }
            
            editingExpenseId = null;
            usedBySelection = [];
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseCalc').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCurrency').value = 'THB';
            document.getElementById('expensePaidBy').value = 'public';
            document.getElementById('expenseFormTitle').textContent = 'æ–°å¢æ”¯å‡º';
            document.getElementById('expenseSubmitBtn').textContent = 'æ–°å¢æ”¯å‡º';
            document.getElementById('expenseSubmitBtn').className = 'px-4 py-2 bg-blue-500 text-white rounded btn';
            
            updateExpenseOptions();
        }

        // æ–°å¢æ”¯å‡º
        function addExpense() {
            const description = document.getElementById('expenseDesc').value;
            const calcInput = document.getElementById('expenseCalc').value;
            const directAmount = document.getElementById('expenseAmount').value;
            const currency = document.getElementById('expenseCurrency').value;
            const paidBy = document.getElementById('expensePaidBy').value;
            const date = document.getElementById('expenseDate').value;
            
            const amount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validUsedBy = usedBySelection.filter(f => getValidFriends().includes(f));
            
            if (description && amount > 0 && validUsedBy.length > 0) {
                if (editingExpenseId !== null) {
                    // æ›´æ–°æ”¯å‡º
                    const expenseIndex = expenses.findIndex(e => e.id === editingExpenseId);
                    expenses[expenseIndex] = {
                        id: editingExpenseId,
                        description,
                        amount,
                        currency,
                        paidBy,
                        usedBy: validUsedBy,
                        date
                    };
                } else {
                    // æ–°å¢æ”¯å‡º
                    expenses.push({
                        id: Date.now(),
                        description,
                        amount,
                        currency,
                        paidBy,
                        usedBy: validUsedBy,
                        date
                    });
                }
                
                // å¦‚æœæ˜¯å…¬è²»æ”¯ä»˜ï¼Œæ‰£é™¤å…¬è²»
                if (paidBy === 'public') {
                    publicFunds[currency] -= amount;
                }
                
                updateDisplay();
                renderExpenses();
                toggleAddExpense();
            }
        }

        // ç·¨è¼¯æ”¯å‡º
        function editExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;
            
            // å¦‚æœåŸæœ¬æ˜¯å…¬è²»æ”¯ä»˜ï¼Œå…ˆé€€å›å…¬è²»
            if (expense.paidBy === 'public') {
                publicFunds[expense.currency] += expense.amount;
            }
            
            editingExpenseId = expenseId;
            usedBySelection = [...expense.usedBy];
            
            // å¡«å…¥è¡¨å–®
            document.getElementById('expenseDesc').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseCurrency').value = expense.currency;
            document.getElementById('expensePaidBy').value = expense.paidBy;
            document.getElementById('expenseDate').value = expense.date;
            
            document.getElementById('expenseFormTitle').textContent = 'ç·¨è¼¯æ”¯å‡º';
            document.getElementById('expenseSubmitBtn').textContent = 'æ›´æ–°æ”¯å‡º';
            document.getElementById('expenseSubmitBtn').className = 'px-4 py-2 bg-orange-500 text-white rounded btn';
            
            document.getElementById('addExpenseForm').classList.remove('hidden');
            updateExpenseOptions();
        }

        // åˆªé™¤æ”¯å‡º
        function removeExpense(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (expense && expense.paidBy === 'public') {
                publicFunds[expense.currency] += expense.amount;
            }
            expenses = expenses.filter(e => e.id !== expenseId);
            
            updateDisplay();
            renderExpenses();
        }

        // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
        function renderExpenses() {
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            
            expenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-lg border border-blue-200';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-2">
                                <span class="font-semibold text-lg">${expense.description}</span>
                                <span class="text-blue-600 font-bold">${expense.currency} ${expense.amount.toFixed(2)}</span>
                                <span class="text-sm text-gray-500">${expense.date}</span>
                            </div>
