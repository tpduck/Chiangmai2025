<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…é‚æ”¾ç©ºåœ˜ - è¨˜å¸³ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .btn {
            transition: all 0.2s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .card {
            transition: all 0.3s;
        }
        .card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-yellow-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-orange-600 mb-2">ğŸ›ï¸ æ¸…é‚æ”¾ç©ºåœ˜ ğŸ›º</h1>
                <p class="text-gray-600">è¨˜å¸³ç®¡ç†ç³»çµ±</p>
                
                <!-- è³‡æ–™ç®¡ç†æŒ‰éˆ• -->
                <div class="mt-4 flex flex-wrap justify-center gap-2">
                    <button onclick="exportData()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 btn">
                        ğŸ“¤ åŒ¯å‡ºè³‡æ–™
                    </button>
                    <button onclick="clearAllData()" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 btn">
                        ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™
                    </button>
                    <div class="text-xs text-gray-500 w-full mt-2">
                        ğŸ’¾ è³‡æ–™æœƒè‡ªå‹•å„²å­˜åœ¨ç€è¦½å™¨ä¸­
                    </div>
                </div>
            </div>

            <!-- åœ˜å“¡ç®¡ç† -->
            <div class="mb-8 bg-orange-50 rounded-lg p-6 card">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="icon text-orange-600" viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h2 class="text-2xl font-bold text-orange-800">åœ˜å“¡ç®¡ç† (6äºº)</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="friendsGrid">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
                
                <div class="mt-4 text-sm text-gray-600" id="friendsStatus">
                    å·²å¡«å¯«åœ˜å“¡: 0/6 äºº
                </div>
            </div>

            <!-- å…¬è²»ç®¡ç† -->
            <div class="mb-8 bg-green-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-green-600" viewBox="0 0 24 24">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <path d="m16 8 2 0 0 8-2 0"></path>
                            <path d="m4 8 0-1c0-.6.4-1 1-1h4c.6 0 1 .4 1 1v1"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-green-800">å…¬è²»ç®¡ç†</h2>
                    </div>
                    <button onclick="toggleAddFunds()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2 btn" id="addFundsBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        æ”¶å–å…¬è²»
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">å…¬è²»é¤˜é¡</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">å°å¹£é¤˜é¡</div>
                            <div class="text-2xl font-bold text-green-600" id="twdBalance">TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">æ³°éŠ–é¤˜é¡</div>
                            <div class="text-2xl font-bold text-green-600" id="thbBalance">THB 0.00</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">æ¯äººå·²ç¹³å…¬è²»</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">å°å¹£ (æ¯äºº)</div>
                            <div class="text-xl font-bold text-blue-600" id="twdContribution">TWD 0.00</div>
                            <div class="text-xs text-gray-500" id="twdTotal">ç¸½è¨ˆ: TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">æ³°éŠ– (æ¯äºº)</div>
                            <div class="text-xl font-bold text-blue-600" id="thbContribution">THB 0.00</div>
                            <div class="text-xs text-gray-500" id="thbTotal">ç¸½è¨ˆ: THB 0.00</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-green-200 hidden" id="addFundsForm">
                    <h3 class="font-semibold text-green-800 mb-3">æ”¶å–å…¬è²» (<span id="fundsPersonCount">0</span> äºº)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ¯äººé‡‘é¡è¨ˆç®—</label>
                            <input type="text" id="fundCalc" placeholder="ä¾‹: 100*5+50" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div class="text-xs text-gray-500 mt-1">æ¯äºº: <span id="fundCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æˆ–ç›´æ¥è¼¸å…¥æ¯äººé‡‘é¡</label>
                            <input type="number" id="fundAmount" placeholder="æ¯äººé‡‘é¡" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¹£åˆ¥</label>
                            <select id="fundCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="THB">æ³°éŠ– (THB)</option>
                                <option value="TWD">å°å¹£ (TWD)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-gray-50 rounded text-sm" id="fundPreview">
                        <strong>é è¦½:</strong> æ¯äººç¹³äº¤ 0 THBï¼Œç¸½è¨ˆæ”¶å…¥ 0 THB
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="addPublicFund()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn">æ”¶å–å…¬è²»</button>
                        <button onclick="toggleAddFunds()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ”¯å‡ºç®¡ç† -->
            <div class="mb-8 bg-blue-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-blue-600" viewBox="0 0 24 24">
                            <path d="M12 1v22"></path>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-blue-800">æ”¯å‡ºè¨˜éŒ„</h2>
                    </div>
                    <button onclick="toggleAddExpense()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 btn" id="addExpenseBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        æ–°å¢æ”¯å‡º
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg border border-blue-200 mb-4 hidden" id="addExpenseForm">
                    <h3 class="font-semibold text-blue-800 mb-3" id="expenseFormTitle">æ–°å¢æ”¯å‡º</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ”¯å‡ºæè¿°</label>
                            <input type="text" id="expenseDesc" placeholder="ä¾‹: æ™šé¤è²»ç”¨" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ—¥æœŸ</label>
                            <input type="date" id="expenseDate" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">é‡‘é¡è¨ˆç®—</label>
                            <input type="text" id="expenseCalc" placeholder="ä¾‹: 200*3+150" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="text-xs text-gray-500 mt-1">è¨ˆç®—çµæœ: <span id="expenseCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æˆ–ç›´æ¥è¼¸å…¥é‡‘é¡</label>
                            <input type="number" id="expenseAmount" placeholder="é‡‘é¡" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¹£åˆ¥</label>
                            <select id="expenseCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="THB">æ³°éŠ– (THB)</option>
                                <option value="TWD">å°å¹£ (TWD)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾æ–¹å¼</label>
                            <select id="expensePaidBy" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="public">å…¬è²»æ”¯ä»˜</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨äººå“¡</label>
                            <div class="flex flex-wrap gap-2" id="usedByButtons">
                                <!-- å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="addExpense()" class="px-4 py-2 bg-blue-500 text-white rounded btn" id="expenseSubmitBtn">æ–°å¢æ”¯å‡º</button>
                        <button onclick="cancelExpenseEdit()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">å–æ¶ˆ</button>
                    </div>
                </div>

                <!-- æ”¯å‡ºåˆ—è¡¨ -->
                <div class="space-y-3" id="expensesList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æœ€çµ‚çµç®— -->
            <div class="bg-purple-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-purple-600" viewBox="0 0 24 24">
                            <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                            <rect x="9" y="9" width="1" height="1"></rect>
                            <rect x="14" y="9" width="1" height="1"></rect>
                            <rect x="9" y="14" width="1" height="1"></rect>
                            <rect x="14" y="14" width="1" height="1"></rect>
                        </svg>
                        <h2 class="text-2xl font-bold text-purple-800">æœ€çµ‚çµç®—</h2>
                    </div>
                    <button onclick="toggleSettlement()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 btn" id="settlementBtn">é¡¯ç¤º çµç®—</button>
                </div>

                <div class="space-y-4 hidden" id="settlementContent">
                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">æœ€çµ‚çµç®—æ˜ç´° (å·²å«å·²ç¹³å…¬è²»)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="settlementGrid">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">èªªæ˜</h3>
                        <div class="text-sm text-gray-600 space-y-2">
                            <p>â€¢ <strong>ğŸ’° ç¶ è‰²æ•¸å­—</strong>ï¼šè¡¨ç¤ºæ­¤äººæ‡‰æ”¶å›çš„é‡‘é¡ï¼ˆå·²ä»˜è¶…éæ‡‰ä»˜ï¼‰</p>
                            <p>â€¢ <strong>ğŸ’¸ ç´…è‰²æ•¸å­—</strong>ï¼šè¡¨ç¤ºæ­¤äººéœ€è£œç¹³çš„é‡‘é¡ï¼ˆæ‡‰ä»˜è¶…éå·²ä»˜ï¼‰</p>
                            <p>â€¢ è¨ˆç®—å·²åŒ…å«æ¯äººå·²ç¹³äº¤çš„å…¬è²»é‡‘é¡</p>
                            <p>â€¢ åŒ¯ç‡: 1 TWD = 1.1 THB</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let friends = ['', '', '', '', '', ''];
        let publicFunds = { TWD: 0, THB: 0 };
        let publicContributions = { TWD: 0, THB: 0 };
        let expenses = [];
        let editingExpenseId = null;
        let usedBySelection = [];
        const exchangeRate = 1.1;

        // å„²å­˜è³‡æ–™åˆ°æœ¬åœ°å­˜å„²
        function saveData() {
            const data = {
                friends,
                publicFunds,
                publicContributions,
                expenses,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('chiangMaiExpenseTracker', JSON.stringify(data));
            
            // é¡¯ç¤ºå„²å­˜æç¤º
            showSaveNotification();
        }

        // è¼‰å…¥è³‡æ–™å¾æœ¬åœ°å­˜å„²
        function loadData() {
            const savedData = localStorage.getItem('chiangMaiExpenseTracker');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    friends = data.friends || ['', '', '', '', '', ''];
                    publicFunds = data.publicFunds || { TWD: 0, THB: 0 };
                    publicContributions = data.publicContributions || { TWD: 0, THB: 0 };
                    expenses = data.expenses || [];
                    
                    console.log('å·²è¼‰å…¥å„²å­˜çš„è³‡æ–™ï¼Œæœ€å¾Œæ›´æ–°æ™‚é–“:', data.lastUpdated);
                    return true;
                } catch (e) {
                    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', e);
                    return false;
                }
            }
            return false;
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                localStorage.removeItem('chiangMaiExpenseTracker');
                // é‡ç½®æ‰€æœ‰è®Šæ•¸
                friends = ['', '', '', '', '', ''];
                publicFunds = { TWD: 0, THB: 0 };
                publicContributions = { TWD: 0, THB: 0 };
                expenses = [];
                editingExpenseId = null;
                usedBySelection = [];
                
                // é‡æ–°æ¸²æŸ“é é¢
                renderFriends();
                updateDisplay();
                renderExpenses();
                
                alert('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼');
            }
        }

        // åŒ¯å‡ºè³‡æ–™
        function exportData() {
            const data = {
                friends,
                publicFunds,
                publicContributions,
                expenses,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ¸…é‚æ”¾ç©ºåœ˜è¨˜å¸³_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // é¡¯ç¤ºå„²å­˜é€šçŸ¥
        function showSaveNotification() {
            // ç§»é™¤ç¾æœ‰çš„é€šçŸ¥
            const existingNotification = document.getElementById('saveNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // å‰µå»ºæ–°é€šçŸ¥
            const notification = document.createElement('div');
            notification.id = 'saveNotification';
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.innerHTML = 'ğŸ’¾ è³‡æ–™å·²è‡ªå‹•å„²å­˜';
            document.body.appendChild(notification);
            
            // 3ç§’å¾Œç§»é™¤é€šçŸ¥
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 2000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆè¼‰å…¥å„²å­˜çš„è³‡æ–™
            const hasData = loadData();
            
            renderFriends();
            updateExpenseDate();
            updateDisplay();
            renderExpenses();
            setupEventListeners();
            
            if (hasData) {
                console.log('å·²è¼‰å…¥å…ˆå‰çš„è³‡æ–™');
            }
        });

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // å…¬è²»è¨ˆç®—è¼¸å…¥æ¡†
            const fundCalc = document.getElementById('fundCalc');
            const fundAmount = document.getElementById('fundAmount');
            const fundCurrency = document.getElementById('fundCurrency');
            
            if (fundCalc) {
                fundCalc.addEventListener('input', updateFundCalc);
            }
            if (fundAmount) {
                fundAmount.addEventListener('input', updateFundPreview);
            }
            if (fundCurrency) {
                fundCurrency.addEventListener('change', updateFundPreview);
            }
            
            // æ”¯å‡ºè¨ˆç®—è¼¸å…¥æ¡†
            const expenseCalc = document.getElementById('expenseCalc');
            if (expenseCalc) {
                expenseCalc.addEventListener('input', updateExpenseCalc);
            }
        }

        // è¨ˆç®—å‡½æ•¸
        function calculateAmount(input) {
            try {
                return Function('"use strict"; return (' + input + ')')() || 0;
            } catch (e) {
                return 0;
            }
        }

        // ç²å–æœ‰æ•ˆæœ‹å‹
        function getValidFriends() {
            return friends.filter(f => f.trim() !== '');
        }

        // æ¸²æŸ“æœ‹å‹åˆ—è¡¨
        function renderFriends() {
            const grid = document.getElementById('friendsGrid');
            grid.innerHTML = '';
            
            friends.forEach((friend, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                
                const span = document.createElement('span');
                span.className = 'text-sm text-gray-600 w-8';
                span.textContent = `#${index + 1}`;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = friend;
                input.placeholder = `åœ˜å“¡ ${index + 1} å§“å`;
                input.className = 'flex-1 p-3 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500';
                input.addEventListener('input', function() {
                    updateFriend(index, this.value);
                });
                input.addEventListener('blur', function() {
                    updateFriend(index, this.value);
                });
                
                div.appendChild(span);
                div.appendChild(input);
                grid.appendChild(div);
            });
            
            updateFriendsStatus();
            updateExpenseOptions();
        }

        // æ›´æ–°æœ‹å‹
        function updateFriend(index, value) {
            friends[index] = value;
            updateFriendsStatus();
            updateExpenseOptions();
            saveData(); // è‡ªå‹•å„²å­˜
        }

        // æ›´æ–°æœ‹å‹ç‹€æ…‹
        function updateFriendsStatus() {
            const validFriends = getValidFriends();
            document.getElementById('friendsStatus').innerHTML = 
                `å·²å¡«å¯«åœ˜å“¡: ${validFriends.length}/6 äºº${validFriends.length > 0 ? ` (${validFriends.join(', ')})` : ''}`;
        }

        // æ›´æ–°æ”¯å‡ºé¸é …
        function updateExpenseOptions() {
            const validFriends = getValidFriends();
            const paidBySelect = document.getElementById('expensePaidBy');
            const usedByDiv = document.getElementById('usedByButtons');
            
            // æ›´æ–°ä»˜æ¬¾æ–¹å¼
            paidBySelect.innerHTML = '<option value="public">å…¬è²»æ”¯ä»˜</option>';
            validFriends.forEach(friend => {
                paidBySelect.innerHTML += `<option value="${friend}">${friend} å€‹äººæ”¯ä»˜</option>`;
            });
            
            // æ›´æ–°ä½¿ç”¨äººå“¡
            usedByDiv.innerHTML = '';
            validFriends.forEach(friend => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `px-3 py-1 rounded-full text-sm ${
                    usedBySelection.includes(friend) 
                        ? 'bg-blue-500 text-white' 
                        : 'bg-gray-200 text-gray-700'
                }`;
                button.textContent = friend;
                button.onclick = () => toggleUsedBy(friend);
                usedByDiv.appendChild(button);
            });
            
            document.getElementById('fundsPersonCount').textContent = validFriends.length;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const hasValidFriends = validFriends.length > 0;
            document.getElementById('addFundsBtn').disabled = !hasValidFriends;
            document.getElementById('addExpenseBtn').disabled = !hasValidFriends;
        }

        // åˆ‡æ›ä½¿ç”¨äººå“¡
        function toggleUsedBy(friend) {
            const index = usedBySelection.indexOf(friend);
            if (index > -1) {
                usedBySelection.splice(index, 1);
            } else {
                usedBySelection.push(friend);
            }
            updateExpenseOptions();
        }

        // æ›´æ–°å…¬è²»è¨ˆç®—
        function updateFundCalc() {
            const input = document.getElementById('fundCalc').value;
            const result = calculateAmount(input);
            document.getElementById('fundCalcResult').textContent = result;
            updateFundPreview();
        }

        // æ›´æ–°å…¬è²»é è¦½
        function updateFundPreview() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
            const totalAmount = perPersonAmount * validFriends.length;
            
            document.getElementById('fundPreview').innerHTML = 
                `<strong>é è¦½:</strong> æ¯äººç¹³äº¤ ${perPersonAmount} ${currency}ï¼Œç¸½è¨ˆæ”¶å…¥ ${totalAmount} ${currency}`;
        }

        // æ›´æ–°æ”¯å‡ºè¨ˆç®—
        function updateExpenseCalc() {
            const input = document.getElementById('expenseCalc').value;
            const result = calculateAmount(input);
            document.getElementById('expenseCalcResult').textContent = result;
        }

        // æ›´æ–°æ”¯å‡ºæ—¥æœŸ
        function updateExpenseDate() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        // åˆ‡æ›å…¬è²»è¡¨å–®
        function toggleAddFunds() {
            const form = document.getElementById('addFundsForm');
            const isHidden = form.classList.contains('hidden');
            
            if (isHidden) {
                form.classList.remove('hidden');
                updateFundPreview();
                // é‡æ–°ç¶å®šäº‹ä»¶ç›£è½å™¨
                setTimeout(setupEventListeners, 100);
            } else {
                form.classList.add('hidden');
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('fundCalc').value = '';
                document.getElementById('fundAmount').value = '';
                document.getElementById('fundCurrency').value = 'THB';
            }
        }

        // æ–°å¢å…¬è²»
        function addPublicFund() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
