<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清邁放空團 - 記帳管理系統 (同步版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        .btn:hover {
            transform: translateY(-1px);
            transition: all 0.2s;
        }
        .sync-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-yellow-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <!-- 標題 -->
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-orange-600 mb-2">🏛️ 清邁放空團 🛺</h1>
                <p class="text-gray-600">記帳管理系統 (即時同步版)</p>
                
                <!-- 同步狀態 -->
                <div class="mt-2 flex justify-center items-center gap-2">
                    <div id="syncStatus" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-600">
                        🔄 連接中...
                    </div>
                    <div id="userCount" class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-600">
                        👥 線上: 1 人
                    </div>
                </div>
                
                <!-- 資料管理按鈕 -->
                <div class="mt-4 flex flex-wrap justify-center gap-2">
                    <button onclick="exportData()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 btn">
                        📤 匯出備份
                    </button>
                    <button onclick="shareTrip()" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 btn">
                        🔗 分享連結
                    </button>
                    <div class="text-xs text-gray-500 w-full mt-2">
                        ☁️ 資料即時同步到雲端，所有人都能看到更新
                    </div>
                </div>
            </div>

            <!-- 團員管理 -->
            <div class="mb-6 bg-orange-50 rounded-lg p-4">
                <h2 class="text-xl font-bold text-orange-800 mb-3">👥 團員管理 (6人)</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#1</span>
                        <input type="text" id="friend0" placeholder="團員 1 姓名" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#2</span>
                        <input type="text" id="friend1" placeholder="團員 2 姓名" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#3</span>
                        <input type="text" id="friend2" placeholder="團員 3 姓名" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#4</span>
                        <input type="text" id="friend3" placeholder="團員 4 姓名" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#5</span>
                        <input type="text" id="friend4" placeholder="團員 5 姓名" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#6</span>
                        <input type="text" id="friend5" placeholder="團員 6 姓名" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <div class="mt-3 text-sm text-gray-600" id="friendsStatus">
                    已填寫團員: 0/6 人
                </div>
            </div>

            <!-- 公費管理 -->
            <div class="mb-6 bg-green-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-green-800">💰 公費管理</h2>
                    <button onclick="toggleFunds()" id="fundsBtn" 
                            class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn">
                        + 收取公費
                    </button>
                </div>

                <!-- 公費顯示 -->
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="bg-white p-3 rounded border">
                        <div class="text-sm text-gray-600">台幣餘額</div>
                        <div class="text-lg font-bold text-green-600" id="twdBalance">TWD 0</div>
                        <div class="text-xs text-gray-500">每人已繳: <span id="twdContrib">TWD 0</span></div>
                    </div>
                    <div class="bg-white p-3 rounded border">
                        <div class="text-sm text-gray-600">泰銖餘額</div>
                        <div class="text-lg font-bold text-green-600" id="thbBalance">THB 0</div>
                        <div class="text-xs text-gray-500">每人已繳: <span id="thbContrib">THB 0</span></div>
                    </div>
                </div>

                <!-- 公費表單 -->
                <div id="fundsForm" class="bg-white p-3 rounded border hidden">
                    <h3 class="font-semibold text-green-800 mb-2">收取公費</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">每人金額</label>
                            <input type="number" id="fundAmount" placeholder="0" 
                                   class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">幣別</label>
                            <select id="fundCurrency" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="THB">泰銖 (THB)</option>
                                <option value="TWD">台幣 (TWD)</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="addFunds()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn mr-2">
                                確定
                            </button>
                            <button onclick="toggleFunds()" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 支出管理 -->
            <div class="mb-6 bg-blue-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-blue-800">💸 支出記錄</h2>
                    <button onclick="toggleExpense()" id="expenseBtn" 
                            class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 btn">
                        + 新增支出
                    </button>
                </div>

                <!-- 支出表單 -->
                <div id="expenseForm" class="bg-white p-3 rounded border mb-3 hidden">
                    <h3 class="font-semibold text-blue-800 mb-2" id="expenseTitle">新增支出</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">支出描述</label>
                            <input type="text" id="expenseDesc" placeholder="例: 晚餐費用" 
                                   class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">金額</label>
                            <input type="number" id="expenseAmount" placeholder="0" 
                                   class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">幣別</label>
                            <select id="expenseCurrency" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="THB">泰銖 (THB)</option>
                                <option value="TWD">台幣 (TWD)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">付款方式</label>
                            <select id="expensePaidBy" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="public">公費支付</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm text-gray-700 mb-1">使用人員</label>
                        <div id="usedByButtons" class="flex flex-wrap gap-2">
                            <!-- 動態生成 -->
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addExpense()" id="expenseSubmit" 
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 btn">
                            新增支出
                        </button>
                        <button onclick="cancelExpense()" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">
                            取消
                        </button>
                    </div>
                </div>

                <!-- 支出列表 -->
                <div id="expensesList">
                    <!-- 動態生成 -->
                </div>
            </div>

            <!-- 最終結算 -->
            <div class="bg-purple-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-purple-800">🧮 最終結算</h2>
                    <button onclick="toggleSettlement()" id="settlementBtn" 
                            class="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 btn">
                        顯示結算
                    </button>
                </div>

                <div id="settlementContent" class="hidden">
                    <div class="bg-white p-3 rounded border mb-3">
                        <h3 class="font-bold mb-2 text-purple-800">結算明細 (已含已繳公費)</h3>
                        <div id="settlementGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- 動態生成 -->
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded border text-sm text-gray-600">
                        <p><strong>💰 綠色數字</strong>：應收回的金額 | <strong>💸 紅色數字</strong>：需補繳的金額</p>
                        <p>匯率: 1 TWD = 1.1 THB</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Firebase 設定 ===
        // 🚨 請替換為你的 Firebase 設定
       const firebaseConfig = {
  apiKey: "AIzaSyBCpSjxRDuxHqomvk8lwpUtpv0l7F4v7XA",
  authDomain: "chiangmai2025-55a97.firebaseapp.com",
  projectId: "chiangmai2025-55a97",
  storageBucket: "chiangmai2025-55a97.firebasestorage.app",
  messagingSenderId: "26771370031",
  appId: "1:26771370031:web:32ba6c21f2badab5ce96da",
  measurementId: "G-YK69FBF0ZK"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        
        // 獲取或生成旅行 ID
        let tripId = new URLSearchParams(window.location.search).get('trip') || 'default-trip';
        
        // 全域變數
        let data = {
            friends: ['', '', '', '', '', ''],
            publicFunds: { TWD: 0, THB: 0 },
            publicContributions: { TWD: 0, THB: 0 },
            expenses: []
        };
        let editingExpense = null;
        let usedBy = [];

        // === Firebase 同步函數 ===
        
        // 儲存到 Firebase
        function saveToFirebase() {
            const docRef = db.collection('expense-tracker').doc(tripId);
            
            docRef.set({
                ...data,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: getUserId()
            }).then(() => {
                updateSyncStatus('已同步', 'green');
            }).catch((error) => {
                console.error('同步失敗:', error);
                updateSyncStatus('同步失敗', 'red');
            });
        }

        // 從 Firebase 載入
        function loadFromFirebase() {
            const docRef = db.collection('expense-tracker').doc(tripId);
            
            // 即時監聽資料變更
            docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const firebaseData = doc.data();
                    
                    // 更新本地資料
                    data = {
                        friends: firebaseData.friends || ['', '', '', '', '', ''],
                        publicFunds: firebaseData.publicFunds || { TWD: 0, THB: 0 },
                        publicContributions: firebaseData.publicContributions || { TWD: 0, THB: 0 },
                        expenses: firebaseData.expenses || []
                    };
                    
                    updateAll();
                    updateSyncStatus('已連線', 'green');
                } else {
                    // 文件不存在，建立初始資料
                    saveToFirebase();
                }
            }, (error) => {
                console.error('載入失敗:', error);
                updateSyncStatus('連線失敗', 'red');
            });
        }

        // 更新同步狀態
        function updateSyncStatus(text, color) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = `🔄 ${text}`;
                statusEl.className = `text-xs px-2 py-1 rounded-full ${color === 'green' ? 'bg-green-100 text-green-600' : color === 'red' ? 'bg-red-100 text-red-600' : 'bg-gray-200 text-gray-600'}`;
            }
        }

        // 獲取使用者 ID
        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        }

        // === 原有功能函數（修改為同步版本）===
        
        // 顯示通知
        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-3 py-2 rounded shadow-lg z-50';
            notification.textContent = text;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // 分享旅行連結
        function shareTrip() {
            const url = `${window.location.origin}${window.location.pathname}?trip=${tripId}`;
            if (navigator.share) {
                navigator.share({
                    title: '清邁放空團記帳',
                    text: '加入我們的記帳系統',
                    url: url
                });
            } else {
                // 複製到剪貼板
                navigator.clipboard.writeText(url).then(() => {
                    alert('分享連結已複製到剪貼板！\n\n' + url);
                }).catch(() => {
                    prompt('請複製以下連結分享給團員：', url);
                });
            }
        }

        // 匯出資料（備份用）
        function exportData() {
            const exportData = {
                ...data,
                tripId: tripId,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `清邁記帳備份_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 獲取有效朋友
        function getValidFriends() {
            return data.friends.filter(f => f.trim() !== '');
        }

        // 更新朋友狀態
        function updateFriendsStatus() {
            const valid = getValidFriends();
            const status = document.getElementById('friendsStatus');
            if (status) {
                status.textContent = `已填寫團員: ${valid.length}/6 人${valid.length > 0 ? ` (${valid.join(', ')})` : ''}`;
            }
        }

        // 更新顯示
        function updateDisplay() {
            const twdBalance = document.getElementById('twdBalance');
            const thbBalance = document.getElementById('thbBalance');
            const twdContrib = document.getElementById('twdContrib');
            const thbContrib = document.getElementById('thbContrib');
            
            if (twdBalance) twdBalance.textContent = `TWD ${data.publicFunds.TWD.toFixed(0)}`;
            if (thbBalance) thbBalance.textContent = `THB ${data.publicFunds.THB.toFixed(0)}`;
            if (twdContrib) twdContrib.textContent = `TWD ${data.publicContributions.TWD.toFixed(0)}`;
            if (thbContrib) thbContrib.textContent = `THB ${data.publicContributions.THB.toFixed(0)}`;
        }

        // 更新支出選項
        function updateExpenseOptions() {
            const validFriends = getValidFriends();
            const paidBySelect = document.getElementById('expensePaidBy');
            const buttonsDiv = document.getElementById('usedByButtons');
            
            if (paidBySelect) {
                paidBySelect.innerHTML = '<option value="public">公費支付</option>';
                validFriends.forEach(friend => {
                    paidBySelect.innerHTML += `<option value="${friend}">${friend} 個人支付</option>`;
                });
            }
            
            if (buttonsDiv) {
                buttonsDiv.innerHTML = '';
                validFriends.forEach(friend => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = friend;
                    btn.className = `px-2 py-1 text-sm rounded ${usedBy.includes(friend) ? 'bg-blue-500 text-white' : 'bg-gray-200'}`;
                    btn.onclick = () => toggleUsedBy(friend);
                    buttonsDiv.appendChild(btn);
                });
            }
        }

        // 切換使用人員
        function toggleUsedBy(friend) {
            if (usedBy.includes(friend)) {
                usedBy = usedBy.filter(f => f !== friend);
            } else {
                usedBy.push(friend);
            }
            updateExpenseOptions();
        }

        // 更新所有內容
        function updateAll() {
            for (let i = 0; i < 6; i++) {
                const input = document.getElementById(`friend${i}`);
                if (input) {
                    input.value = data.friends[i] || '';
                }
            }
            
            updateFriendsStatus();
            updateDisplay();
            updateExpenseOptions();
            renderExpenses();
        }

        // 切換公費表單
        function toggleFunds() {
            const form = document.getElementById('fundsForm');
            const btn = document.getElementById('fundsBtn');
            if (form && btn) {
                if (form.classList.contains('hidden')) {
                    form.classList.remove('hidden');
                    btn.textContent = '- 取消';
                } else {
                    form.classList.add('hidden');
                    btn.textContent = '+ 收取公費';
                    document.getElementById('fundAmount').value = '';
                }
            }
        }

        // 新增公費
        function addFunds() {
            const amount = parseFloat(document.getElementById('fundAmount').value) || 0;
            const currency = document.getElementById('fundCurrency').value;
            const validFriends = getValidFriends();
            
            if (amount > 0 && validFriends.length > 0) {
                const total = amount * validFriends.length;
                data.publicFunds[currency] += total;
                data.publicContributions[currency] += amount;
                
                updateDisplay();
                toggleFunds();
                saveToFirebase(); // 同步到 Firebase
                showNotification('☁️ 公費已記錄並同步');
            }
        }

        // 切換支出表單
        function toggleExpense() {
            const form = document.getElementById('expenseForm');
            const btn = document.getElementById('expenseBtn');
            if (form && btn) {
                if (form.classList.contains('hidden')) {
                    form.classList.remove('hidden');
                    btn.textContent = '- 取消';
                    usedBy = [...getValidFriends()];
                    updateExpenseOptions();
                } else {
                    form.classList.add('hidden');
                    btn.textContent = '+ 新增支出';
                    cancelExpense();
                }
            }
        }

        // 取消支出
        function cancelExpense() {
            editingExpense = null;
            usedBy = [];
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseTitle').textContent = '新增支出';
            document.getElementById('expenseSubmit').textContent = '新增支出';
            updateExpenseOptions();
        }

        // 新增/更新支出
        function addExpense() {
            const desc = document.getElementById('expenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const currency = document.getElementById('expenseCurrency').value;
            const paidBy = document.getElementById('expensePaidBy').value;
            
            if (!desc || amount <= 0 || usedBy.length === 0) {
                alert('請填寫完整資訊！');
                return;
            }
            
            const expense = {
                id: editingExpense || Date.now(),
                description: desc,
                amount: amount,
                currency: currency,
                paidBy: paidBy,
                usedBy: [...usedBy],
                date: new Date().toISOString().split('T')[0],
                createdBy: getUserId()
            };
            
            if (editingExpense) {
                const index = data.expenses.findIndex(e => e.id === editingExpense);
                data.expenses[index] = expense;
            } else {
                data.expenses.push(expense);
            }
            
            if (paidBy === 'public') {
                data.publicFunds[currency] -= amount;
            }
            
            updateDisplay();
            renderExpenses();
            toggleExpense();
            saveToFirebase(); // 同步到 Firebase
            showNotification('☁️ 支出已記錄並同步');
        }

        // 編輯支出
        function editExpense(id) {
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;
            
            if (expense.paidBy === 'public') {
                data.publicFunds[expense.currency] += expense.amount;
            }
            
            editingExpense = id;
            usedBy = [...expense.usedBy];
            
            document.getElementById('expenseDesc').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseCurrency').value = expense.currency;
            document.getElementById('expensePaidBy').value = expense.paidBy;
            document.getElementById('expenseTitle').textContent = '編輯支出';
            document.getElementById('expenseSubmit').textContent = '更新支出';
            
            document.getElementById('expenseForm').classList.remove('hidden');
            document.getElementById('expenseBtn').textContent = '- 取消';
            
            updateExpenseOptions();
        }

        // 刪除支出
        function deleteExpense(id) {
            if (!confirm('確定要刪除這筆支出嗎？')) return;
            
            const expense = data.expenses.find(e => e.id === id);
            if (expense && expense.paidBy === 'public') {
                data.publicFunds[expense.currency] += expense.amount;
            }
            
            data.expenses = data.expenses.filter(e => e.id !== id);
            updateDisplay();
            renderExpenses();
            saveToFirebase(); // 同步到 Firebase
            showNotification('☁️ 支出已刪除並同步');
        }

        // 渲染支出列表
        function renderExpenses() {
            const list = document.getElementById('expensesList');
            if (!list) return;
            
            if (data.expenses.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-center py-4">尚無支出記錄</div>';
                return;
            }
            
            list.innerHTML = data.expenses.map(expense => `
                <div class="bg-white p-3 rounded border mb-2">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold">${expense.description}</div>
                            <div class="text-sm text-gray-600">
                                ${expense.currency} ${expense.amount} | 
                                付款: ${expense.paidBy === 'public' ? '公費' : expense.paidBy} | 
                                使用: ${expense.usedBy.join(', ')} | 
                                人均: ${expense.currency} ${(expense.amount / expense.usedBy.length).toFixed(0)}
                            </div>
                            <div class="text-xs text-gray-500">${expense.date}</div>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button onclick="editExpense(${expense.id})" 
                                    class="px-2 py-1 text-xs bg-orange-500 text-white rounded hover:bg-orange-600">
                                編輯
                            </button>
                            <button onclick="deleteExpense(${expense.id})" 
                                    class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                                刪除
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 切換結算
        function toggleSettlement() {
            const content = document.getElementById('settlementContent');
            const btn = document.getElementById('settlementBtn');
            if (content && btn) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    btn.textContent = '隱藏結算';
                    renderSettlement();
                } else {
                    content.classList.add('hidden');
                    btn.textContent = '顯示結算';
                }
            }
        }

        // 渲染結算
        function renderSettlement() {
            const validFriends = getValidFriends();
            const grid = document.getElementById('settlementGrid');
            if (!grid || validFriends.length === 0) return;
            
            const balances = {};
            validFriends.forEach(friend => {
                balances[friend] = { TWD: 0, THB: 0 };
            });
            
            data.expenses.forEach(expense => {
                const perPerson = expense.amount / expense.usedBy.length;
                expense.usedBy.forEach(user => {
                    if (validFriends.includes(user)) {
                        balances[user][expense.currency] -= perPerson;
                    }
                });
                if (expense.paidBy !== 'public' && validFriends.includes(expense.paidBy)) {
                    balances[expense.paidBy][expense.currency] += expense.amount;
                }
            });
            
            validFriends.forEach(friend => {
                balances[friend].TWD += data.publicContributions.TWD;
                balances[friend].THB += data.publicContributions.THB;
            });
            
            grid.innerHTML = validFriends.map(friend => {
                const balance = balances[friend];
                const totalTWD = balance.TWD + (balance.THB / 1.1);
                const isPositive = totalTWD >= 0;
                
                return `
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-semibold mb-2">${friend}</div>
                        <div class="text-sm space-y-1">
                            <div>台幣: <span class="${balance.TWD >= 0 ? 'text-green-600' : 'text-red-600'}">
                                TWD ${balance.TWD.toFixed(0)}
                            </span></div>
                            <div>泰銖: <span class="${balance.THB >= 0 ? 'text-green-600' : 'text-red-600'}">
                                THB ${balance.THB.toFixed(0)}
                            </span></div>
                            <div class="border-t pt-1">
                                總計: <span class="font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                                    TWD ${totalTWD.toFixed(0)}
                                </span>
                            </div>
                            <div class="text-xs">
                                ${isPositive ? '💰 應收回' : '💸 需補繳'} TWD ${Math.abs(totalTWD).toFixed(0)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 先連接 Firebase
            loadFromFirebase();
            
            // 綁定朋友輸入框事件
            for (let i = 0; i < 6; i++) {
                const input = document.getElementById(`friend${i}`);
                if (input) {
                    input.addEventListener('input', function() {
                        data.friends[i] = this.value;
                        updateFriendsStatus();
                        updateExpenseOptions();
                        saveToFirebase(); // 即時同步
                    });
                }
            }
            
            // 顯示旅行 ID
            if (tripId !== 'default-trip') {
                document.title += ` - ${tripId}`;
            }
        });
    </script>
</body>
</html>
