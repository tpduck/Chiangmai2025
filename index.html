<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…é‚æ”¾ç©ºåœ˜ - è¨˜å¸³ç®¡ç†ç³»çµ± (åŒæ­¥ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        .btn:hover {
            transform: translateY(-1px);
            transition: all 0.2s;
        }
        .sync-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-yellow-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <!-- æ¨™é¡Œ -->
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-orange-600 mb-2">ğŸ›ï¸ æ¸…é‚æ”¾ç©ºåœ˜ ğŸ›º</h1>
                <p class="text-gray-600">è¨˜å¸³ç®¡ç†ç³»çµ± (å³æ™‚åŒæ­¥ç‰ˆ)</p>
                
                <!-- åŒæ­¥ç‹€æ…‹ -->
                <div class="mt-2 flex justify-center items-center gap-2">
                    <div id="syncStatus" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-600">
                        ğŸ”„ é€£æ¥ä¸­...
                    </div>
                    <div id="userCount" class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-600">
                        ğŸ‘¥ ç·šä¸Š: 1 äºº
                    </div>
                </div>
                
                <!-- è³‡æ–™ç®¡ç†æŒ‰éˆ• -->
                <div class="mt-4 flex flex-wrap justify-center gap-2">
                    <button onclick="exportData()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 btn">
                        ğŸ“¤ åŒ¯å‡ºå‚™ä»½
                    </button>
                    <button onclick="shareTrip()" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 btn">
                        ğŸ”— åˆ†äº«é€£çµ
                    </button>
                    <div class="text-xs text-gray-500 w-full mt-2">
                        â˜ï¸ è³‡æ–™å³æ™‚åŒæ­¥åˆ°é›²ç«¯ï¼Œæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°æ›´æ–°
                    </div>
                </div>
            </div>

            <!-- åœ˜å“¡ç®¡ç† -->
            <div class="mb-6 bg-orange-50 rounded-lg p-4">
                <h2 class="text-xl font-bold text-orange-800 mb-3">ğŸ‘¥ åœ˜å“¡ç®¡ç† (6äºº)</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#1</span>
                        <input type="text" id="friend0" placeholder="åœ˜å“¡ 1 å§“å" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#2</span>
                        <input type="text" id="friend1" placeholder="åœ˜å“¡ 2 å§“å" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#3</span>
                        <input type="text" id="friend2" placeholder="åœ˜å“¡ 3 å§“å" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#4</span>
                        <input type="text" id="friend3" placeholder="åœ˜å“¡ 4 å§“å" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#5</span>
                        <input type="text" id="friend4" placeholder="åœ˜å“¡ 5 å§“å" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-6">#6</span>
                        <input type="text" id="friend5" placeholder="åœ˜å“¡ 6 å§“å" 
                               class="flex-1 p-2 border border-orange-200 rounded focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <div class="mt-3 text-sm text-gray-600" id="friendsStatus">
                    å·²å¡«å¯«åœ˜å“¡: 0/6 äºº
                </div>
            </div>

            <!-- å…¬è²»ç®¡ç† -->
            <div class="mb-6 bg-green-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-green-800">ğŸ’° å…¬è²»ç®¡ç†</h2>
                    <button onclick="toggleFunds()" id="fundsBtn" 
                            class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn">
                        + æ”¶å–å…¬è²»
                    </button>
                </div>

                <!-- å…¬è²»é¡¯ç¤º -->
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="bg-white p-3 rounded border">
                        <div class="text-sm text-gray-600">å°å¹£é¤˜é¡</div>
                        <div class="text-lg font-bold text-green-600" id="twdBalance">TWD 0</div>
                        <div class="text-xs text-gray-500">æ¯äººå·²ç¹³: <span id="twdContrib">TWD 0</span></div>
                    </div>
                    <div class="bg-white p-3 rounded border">
                        <div class="text-sm text-gray-600">æ³°éŠ–é¤˜é¡</div>
                        <div class="text-lg font-bold text-green-600" id="thbBalance">THB 0</div>
                        <div class="text-xs text-gray-500">æ¯äººå·²ç¹³: <span id="thbContrib">THB 0</span></div>
                    </div>
                </div>

                <!-- å…¬è²»è¡¨å–® -->
                <div id="fundsForm" class="bg-white p-3 rounded border hidden">
                    <h3 class="font-semibold text-green-800 mb-2">æ”¶å–å…¬è²»</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">æ¯äººé‡‘é¡</label>
                            <input type="number" id="fundAmount" placeholder="0" 
                                   class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">å¹£åˆ¥</label>
                            <select id="fundCurrency" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="THB">æ³°éŠ– (THB)</option>
                                <option value="TWD">å°å¹£ (TWD)</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="addFunds()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn mr-2">
                                ç¢ºå®š
                            </button>
                            <button onclick="toggleFunds()" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”¯å‡ºç®¡ç† -->
            <div class="mb-6 bg-blue-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-blue-800">ğŸ’¸ æ”¯å‡ºè¨˜éŒ„</h2>
                    <button onclick="toggleExpense()" id="expenseBtn" 
                            class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 btn">
                        + æ–°å¢æ”¯å‡º
                    </button>
                </div>

                <!-- æ”¯å‡ºè¡¨å–® -->
                <div id="expenseForm" class="bg-white p-3 rounded border mb-3 hidden">
                    <h3 class="font-semibold text-blue-800 mb-2" id="expenseTitle">æ–°å¢æ”¯å‡º</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">æ”¯å‡ºæè¿°</label>
                            <input type="text" id="expenseDesc" placeholder="ä¾‹: æ™šé¤è²»ç”¨" 
                                   class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">é‡‘é¡</label>
                            <input type="number" id="expenseAmount" placeholder="0" 
                                   class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">å¹£åˆ¥</label>
                            <select id="expenseCurrency" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="THB">æ³°éŠ– (THB)</option>
                                <option value="TWD">å°å¹£ (TWD)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-700 mb-1">ä»˜æ¬¾æ–¹å¼</label>
                            <select id="expensePaidBy" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="public">å…¬è²»æ”¯ä»˜</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm text-gray-700 mb-1">ä½¿ç”¨äººå“¡</label>
                        <div id="usedByButtons" class="flex flex-wrap gap-2">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="addExpense()" id="expenseSubmit" 
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 btn">
                            æ–°å¢æ”¯å‡º
                        </button>
                        <button onclick="cancelExpense()" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>

                <!-- æ”¯å‡ºåˆ—è¡¨ -->
                <div id="expensesList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æœ€çµ‚çµç®— -->
            <div class="bg-purple-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xl font-bold text-purple-800">ğŸ§® æœ€çµ‚çµç®—</h2>
                    <button onclick="toggleSettlement()" id="settlementBtn" 
                            class="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 btn">
                        é¡¯ç¤ºçµç®—
                    </button>
                </div>

                <div id="settlementContent" class="hidden">
                    <div class="bg-white p-3 rounded border mb-3">
                        <h3 class="font-bold mb-2 text-purple-800">çµç®—æ˜ç´° (å·²å«å·²ç¹³å…¬è²»)</h3>
                        <div id="settlementGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded border text-sm text-gray-600">
                        <p><strong>ğŸ’° ç¶ è‰²æ•¸å­—</strong>ï¼šæ‡‰æ”¶å›çš„é‡‘é¡ | <strong>ğŸ’¸ ç´…è‰²æ•¸å­—</strong>ï¼šéœ€è£œç¹³çš„é‡‘é¡</p>
                        <p>åŒ¯ç‡: 1 TWD = 1.1 THB</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Firebase è¨­å®š ===
        // ğŸš¨ è«‹æ›¿æ›ç‚ºä½ çš„ Firebase è¨­å®š
       const firebaseConfig = {
  apiKey: "AIzaSyBCpSjxRDuxHqomvk8lwpUtpv0l7F4v7XA",
  authDomain: "chiangmai2025-55a97.firebaseapp.com",
  projectId: "chiangmai2025-55a97",
  storageBucket: "chiangmai2025-55a97.firebasestorage.app",
  messagingSenderId: "26771370031",
  appId: "1:26771370031:web:32ba6c21f2badab5ce96da",
  measurementId: "G-YK69FBF0ZK"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        
        // ç²å–æˆ–ç”Ÿæˆæ—…è¡Œ ID
        let tripId = new URLSearchParams(window.location.search).get('trip') || 'default-trip';
        
        // å…¨åŸŸè®Šæ•¸
        let data = {
            friends: ['', '', '', '', '', ''],
            publicFunds: { TWD: 0, THB: 0 },
            publicContributions: { TWD: 0, THB: 0 },
            expenses: []
        };
        let editingExpense = null;
        let usedBy = [];

        // === Firebase åŒæ­¥å‡½æ•¸ ===
        
        // å„²å­˜åˆ° Firebase
        function saveToFirebase() {
            const docRef = db.collection('expense-tracker').doc(tripId);
            
            docRef.set({
                ...data,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                updatedBy: getUserId()
            }).then(() => {
                updateSyncStatus('å·²åŒæ­¥', 'green');
            }).catch((error) => {
                console.error('åŒæ­¥å¤±æ•—:', error);
                updateSyncStatus('åŒæ­¥å¤±æ•—', 'red');
            });
        }

        // å¾ Firebase è¼‰å…¥
        function loadFromFirebase() {
            const docRef = db.collection('expense-tracker').doc(tripId);
            
            // å³æ™‚ç›£è½è³‡æ–™è®Šæ›´
            docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const firebaseData = doc.data();
                    
                    // æ›´æ–°æœ¬åœ°è³‡æ–™
                    data = {
                        friends: firebaseData.friends || ['', '', '', '', '', ''],
                        publicFunds: firebaseData.publicFunds || { TWD: 0, THB: 0 },
                        publicContributions: firebaseData.publicContributions || { TWD: 0, THB: 0 },
                        expenses: firebaseData.expenses || []
                    };
                    
                    updateAll();
                    updateSyncStatus('å·²é€£ç·š', 'green');
                } else {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå»ºç«‹åˆå§‹è³‡æ–™
                    saveToFirebase();
                }
            }, (error) => {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                updateSyncStatus('é€£ç·šå¤±æ•—', 'red');
            });
        }

        // æ›´æ–°åŒæ­¥ç‹€æ…‹
        function updateSyncStatus(text, color) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = `ğŸ”„ ${text}`;
                statusEl.className = `text-xs px-2 py-1 rounded-full ${color === 'green' ? 'bg-green-100 text-green-600' : color === 'red' ? 'bg-red-100 text-red-600' : 'bg-gray-200 text-gray-600'}`;
            }
        }

        // ç²å–ä½¿ç”¨è€… ID
        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        }

        // === åŸæœ‰åŠŸèƒ½å‡½æ•¸ï¼ˆä¿®æ”¹ç‚ºåŒæ­¥ç‰ˆæœ¬ï¼‰===
        
        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-3 py-2 rounded shadow-lg z-50';
            notification.textContent = text;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // åˆ†äº«æ—…è¡Œé€£çµ
        function shareTrip() {
            const url = `${window.location.origin}${window.location.pathname}?trip=${tripId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'æ¸…é‚æ”¾ç©ºåœ˜è¨˜å¸³',
                    text: 'åŠ å…¥æˆ‘å€‘çš„è¨˜å¸³ç³»çµ±',
                    url: url
                });
            } else {
                // è¤‡è£½åˆ°å‰ªè²¼æ¿
                navigator.clipboard.writeText(url).then(() => {
                    alert('åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\n\n' + url);
                }).catch(() => {
                    prompt('è«‹è¤‡è£½ä»¥ä¸‹é€£çµåˆ†äº«çµ¦åœ˜å“¡ï¼š', url);
                });
            }
        }

        // åŒ¯å‡ºè³‡æ–™ï¼ˆå‚™ä»½ç”¨ï¼‰
        function exportData() {
            const exportData = {
                ...data,
                tripId: tripId,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ¸…é‚è¨˜å¸³å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ç²å–æœ‰æ•ˆæœ‹å‹
        function getValidFriends() {
            return data.friends.filter(f => f.trim() !== '');
        }

        // æ›´æ–°æœ‹å‹ç‹€æ…‹
        function updateFriendsStatus() {
            const valid = getValidFriends();
            const status = document.getElementById('friendsStatus');
            if (status) {
                status.textContent = `å·²å¡«å¯«åœ˜å“¡: ${valid.length}/6 äºº${valid.length > 0 ? ` (${valid.join(', ')})` : ''}`;
            }
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            const twdBalance = document.getElementById('twdBalance');
            const thbBalance = document.getElementById('thbBalance');
            const twdContrib = document.getElementById('twdContrib');
            const thbContrib = document.getElementById('thbContrib');
            
            if (twdBalance) twdBalance.textContent = `TWD ${data.publicFunds.TWD.toFixed(0)}`;
            if (thbBalance) thbBalance.textContent = `THB ${data.publicFunds.THB.toFixed(0)}`;
            if (twdContrib) twdContrib.textContent = `TWD ${data.publicContributions.TWD.toFixed(0)}`;
            if (thbContrib) thbContrib.textContent = `THB ${data.publicContributions.THB.toFixed(0)}`;
        }

        // æ›´æ–°æ”¯å‡ºé¸é …
        function updateExpenseOptions() {
            const validFriends = getValidFriends();
            const paidBySelect = document.getElementById('expensePaidBy');
            const buttonsDiv = document.getElementById('usedByButtons');
            
            if (paidBySelect) {
                paidBySelect.innerHTML = '<option value="public">å…¬è²»æ”¯ä»˜</option>';
                validFriends.forEach(friend => {
                    paidBySelect.innerHTML += `<option value="${friend}">${friend} å€‹äººæ”¯ä»˜</option>`;
                });
            }
            
            if (buttonsDiv) {
                buttonsDiv.innerHTML = '';
                validFriends.forEach(friend => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = friend;
                    btn.className = `px-2 py-1 text-sm rounded ${usedBy.includes(friend) ? 'bg-blue-500 text-white' : 'bg-gray-200'}`;
                    btn.onclick = () => toggleUsedBy(friend);
                    buttonsDiv.appendChild(btn);
                });
            }
        }

        // åˆ‡æ›ä½¿ç”¨äººå“¡
        function toggleUsedBy(friend) {
            if (usedBy.includes(friend)) {
                usedBy = usedBy.filter(f => f !== friend);
            } else {
                usedBy.push(friend);
            }
            updateExpenseOptions();
        }

        // æ›´æ–°æ‰€æœ‰å…§å®¹
        function updateAll() {
            for (let i = 0; i < 6; i++) {
                const input = document.getElementById(`friend${i}`);
                if (input) {
                    input.value = data.friends[i] || '';
                }
            }
            
            updateFriendsStatus();
            updateDisplay();
            updateExpenseOptions();
            renderExpenses();
        }

        // åˆ‡æ›å…¬è²»è¡¨å–®
        function toggleFunds() {
            const form = document.getElementById('fundsForm');
            const btn = document.getElementById('fundsBtn');
            if (form && btn) {
                if (form.classList.contains('hidden')) {
                    form.classList.remove('hidden');
                    btn.textContent = '- å–æ¶ˆ';
                } else {
                    form.classList.add('hidden');
                    btn.textContent = '+ æ”¶å–å…¬è²»';
                    document.getElementById('fundAmount').value = '';
                }
            }
        }

        // æ–°å¢å…¬è²»
        function addFunds() {
            const amount = parseFloat(document.getElementById('fundAmount').value) || 0;
            const currency = document.getElementById('fundCurrency').value;
            const validFriends = getValidFriends();
            
            if (amount > 0 && validFriends.length > 0) {
                const total = amount * validFriends.length;
                data.publicFunds[currency] += total;
                data.publicContributions[currency] += amount;
                
                updateDisplay();
                toggleFunds();
                saveToFirebase(); // åŒæ­¥åˆ° Firebase
                showNotification('â˜ï¸ å…¬è²»å·²è¨˜éŒ„ä¸¦åŒæ­¥');
            }
        }

        // åˆ‡æ›æ”¯å‡ºè¡¨å–®
        function toggleExpense() {
            const form = document.getElementById('expenseForm');
            const btn = document.getElementById('expenseBtn');
            if (form && btn) {
                if (form.classList.contains('hidden')) {
                    form.classList.remove('hidden');
                    btn.textContent = '- å–æ¶ˆ';
                    usedBy = [...getValidFriends()];
                    updateExpenseOptions();
                } else {
                    form.classList.add('hidden');
                    btn.textContent = '+ æ–°å¢æ”¯å‡º';
                    cancelExpense();
                }
            }
        }

        // å–æ¶ˆæ”¯å‡º
        function cancelExpense() {
            editingExpense = null;
            usedBy = [];
            document.getElementById('expenseDesc').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseTitle').textContent = 'æ–°å¢æ”¯å‡º';
            document.getElementById('expenseSubmit').textContent = 'æ–°å¢æ”¯å‡º';
            updateExpenseOptions();
        }

        // æ–°å¢/æ›´æ–°æ”¯å‡º
        function addExpense() {
            const desc = document.getElementById('expenseDesc').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const currency = document.getElementById('expenseCurrency').value;
            const paidBy = document.getElementById('expensePaidBy').value;
            
            if (!desc || amount <= 0 || usedBy.length === 0) {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼');
                return;
            }
            
            const expense = {
                id: editingExpense || Date.now(),
                description: desc,
                amount: amount,
                currency: currency,
                paidBy: paidBy,
                usedBy: [...usedBy],
                date: new Date().toISOString().split('T')[0],
                createdBy: getUserId()
            };
            
            if (editingExpense) {
                const index = data.expenses.findIndex(e => e.id === editingExpense);
                data.expenses[index] = expense;
            } else {
                data.expenses.push(expense);
            }
            
            if (paidBy === 'public') {
                data.publicFunds[currency] -= amount;
            }
            
            updateDisplay();
            renderExpenses();
            toggleExpense();
            saveToFirebase(); // åŒæ­¥åˆ° Firebase
            showNotification('â˜ï¸ æ”¯å‡ºå·²è¨˜éŒ„ä¸¦åŒæ­¥');
        }

        // ç·¨è¼¯æ”¯å‡º
        function editExpense(id) {
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;
            
            if (expense.paidBy === 'public') {
                data.publicFunds[expense.currency] += expense.amount;
            }
            
            editingExpense = id;
            usedBy = [...expense.usedBy];
            
            document.getElementById('expenseDesc').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseCurrency').value = expense.currency;
            document.getElementById('expensePaidBy').value = expense.paidBy;
            document.getElementById('expenseTitle').textContent = 'ç·¨è¼¯æ”¯å‡º';
            document.getElementById('expenseSubmit').textContent = 'æ›´æ–°æ”¯å‡º';
            
            document.getElementById('expenseForm').classList.remove('hidden');
            document.getElementById('expenseBtn').textContent = '- å–æ¶ˆ';
            
            updateExpenseOptions();
        }

        // åˆªé™¤æ”¯å‡º
        function deleteExpense(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) return;
            
            const expense = data.expenses.find(e => e.id === id);
            if (expense && expense.paidBy === 'public') {
                data.publicFunds[expense.currency] += expense.amount;
            }
            
            data.expenses = data.expenses.filter(e => e.id !== id);
            updateDisplay();
            renderExpenses();
            saveToFirebase(); // åŒæ­¥åˆ° Firebase
            showNotification('â˜ï¸ æ”¯å‡ºå·²åˆªé™¤ä¸¦åŒæ­¥');
        }

        // æ¸²æŸ“æ”¯å‡ºåˆ—è¡¨
        function renderExpenses() {
            const list = document.getElementById('expensesList');
            if (!list) return;
            
            if (data.expenses.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-center py-4">å°šç„¡æ”¯å‡ºè¨˜éŒ„</div>';
                return;
            }
            
            list.innerHTML = data.expenses.map(expense => `
                <div class="bg-white p-3 rounded border mb-2">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-semibold">${expense.description}</div>
                            <div class="text-sm text-gray-600">
                                ${expense.currency} ${expense.amount} | 
                                ä»˜æ¬¾: ${expense.paidBy === 'public' ? 'å…¬è²»' : expense.paidBy} | 
                                ä½¿ç”¨: ${expense.usedBy.join(', ')} | 
                                äººå‡: ${expense.currency} ${(expense.amount / expense.usedBy.length).toFixed(0)}
                            </div>
                            <div class="text-xs text-gray-500">${expense.date}</div>
                        </div>
                        <div class="flex gap-1 ml-2">
                            <button onclick="editExpense(${expense.id})" 
                                    class="px-2 py-1 text-xs bg-orange-500 text-white rounded hover:bg-orange-600">
                                ç·¨è¼¯
                            </button>
                            <button onclick="deleteExpense(${expense.id})" 
                                    class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // åˆ‡æ›çµç®—
        function toggleSettlement() {
            const content = document.getElementById('settlementContent');
            const btn = document.getElementById('settlementBtn');
            if (content && btn) {
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    btn.textContent = 'éš±è—çµç®—';
                    renderSettlement();
                } else {
                    content.classList.add('hidden');
                    btn.textContent = 'é¡¯ç¤ºçµç®—';
                }
            }
        }

        // æ¸²æŸ“çµç®—
        function renderSettlement() {
            const validFriends = getValidFriends();
            const grid = document.getElementById('settlementGrid');
            if (!grid || validFriends.length === 0) return;
            
            const balances = {};
            validFriends.forEach(friend => {
                balances[friend] = { TWD: 0, THB: 0 };
            });
            
            data.expenses.forEach(expense => {
                const perPerson = expense.amount / expense.usedBy.length;
                expense.usedBy.forEach(user => {
                    if (validFriends.includes(user)) {
                        balances[user][expense.currency] -= perPerson;
                    }
                });
                if (expense.paidBy !== 'public' && validFriends.includes(expense.paidBy)) {
                    balances[expense.paidBy][expense.currency] += expense.amount;
                }
            });
            
            validFriends.forEach(friend => {
                balances[friend].TWD += data.publicContributions.TWD;
                balances[friend].THB += data.publicContributions.THB;
            });
            
            grid.innerHTML = validFriends.map(friend => {
                const balance = balances[friend];
                const totalTWD = balance.TWD + (balance.THB / 1.1);
                const isPositive = totalTWD >= 0;
                
                return `
                    <div class="bg-gray-50 p-3 rounded">
                        <div class="font-semibold mb-2">${friend}</div>
                        <div class="text-sm space-y-1">
                            <div>å°å¹£: <span class="${balance.TWD >= 0 ? 'text-green-600' : 'text-red-600'}">
                                TWD ${balance.TWD.toFixed(0)}
                            </span></div>
                            <div>æ³°éŠ–: <span class="${balance.THB >= 0 ? 'text-green-600' : 'text-red-600'}">
                                THB ${balance.THB.toFixed(0)}
                            </span></div>
                            <div class="border-t pt-1">
                                ç¸½è¨ˆ: <span class="font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                                    TWD ${totalTWD.toFixed(0)}
                                </span>
                            </div>
                            <div class="text-xs">
                                ${isPositive ? 'ğŸ’° æ‡‰æ”¶å›' : 'ğŸ’¸ éœ€è£œç¹³'} TWD ${Math.abs(totalTWD).toFixed(0)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆé€£æ¥ Firebase
            loadFromFirebase();
            
            // ç¶å®šæœ‹å‹è¼¸å…¥æ¡†äº‹ä»¶
            for (let i = 0; i < 6; i++) {
                const input = document.getElementById(`friend${i}`);
                if (input) {
                    input.addEventListener('input', function() {
                        data.friends[i] = this.value;
                        updateFriendsStatus();
                        updateExpenseOptions();
                        saveToFirebase(); // å³æ™‚åŒæ­¥
                    });
                }
            }
            
            // é¡¯ç¤ºæ—…è¡Œ ID
            if (tripId !== 'default-trip') {
                document.title += ` - ${tripId}`;
            }
        });
    </script>
</body>
</html>
