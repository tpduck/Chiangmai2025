<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清邁放空團 - 記帳管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .btn {
            transition: all 0.2s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .card {
            transition: all 0.3s;
        }
        .card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-yellow-50 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-orange-600 mb-2">🏛️ 清邁放空團 🛺</h1>
                <p class="text-gray-600">記帳管理系統</p>
                
                <!-- 資料管理按鈕 -->
                <div class="mt-4 flex flex-wrap justify-center gap-2">
                    <button onclick="exportData()" class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 btn">
                        📤 匯出資料
                    </button>
                    <button onclick="clearAllData()" class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 btn">
                        🗑️ 清除資料
                    </button>
                    <div class="text-xs text-gray-500 w-full mt-2">
                        💾 資料會自動儲存在瀏覽器中
                    </div>
                </div>
            </div>

            <!-- 團員管理 -->
            <div class="mb-8 bg-orange-50 rounded-lg p-6 card">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="icon text-orange-600" viewBox="0 0 24 24">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <h2 class="text-2xl font-bold text-orange-800">團員管理 (6人)</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="friendsGrid">
                    <!-- 動態生成 -->
                </div>
                
                <div class="mt-4 text-sm text-gray-600" id="friendsStatus">
                    已填寫團員: 0/6 人
                </div>
            </div>

            <!-- 公費管理 -->
            <div class="mb-8 bg-green-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-green-600" viewBox="0 0 24 24">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <path d="m16 8 2 0 0 8-2 0"></path>
                            <path d="m4 8 0-1c0-.6.4-1 1-1h4c.6 0 1 .4 1 1v1"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-green-800">公費管理</h2>
                    </div>
                    <button onclick="toggleAddFunds()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2 btn" id="addFundsBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        收取公費
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">公費餘額</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">台幣餘額</div>
                            <div class="text-2xl font-bold text-green-600" id="twdBalance">TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">泰銖餘額</div>
                            <div class="text-2xl font-bold text-green-600" id="thbBalance">THB 0.00</div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h3 class="font-semibold text-green-800">每人已繳公費</h3>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">台幣 (每人)</div>
                            <div class="text-xl font-bold text-blue-600" id="twdContribution">TWD 0.00</div>
                            <div class="text-xs text-gray-500" id="twdTotal">總計: TWD 0.00</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-green-200">
                            <div class="text-sm text-gray-600">泰銖 (每人)</div>
                            <div class="text-xl font-bold text-blue-600" id="thbContribution">THB 0.00</div>
                            <div class="text-xs text-gray-500" id="thbTotal">總計: THB 0.00</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-green-200 hidden" id="addFundsForm">
                    <h3 class="font-semibold text-green-800 mb-3">收取公費 (<span id="fundsPersonCount">0</span> 人)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">每人金額計算</label>
                            <input type="text" id="fundCalc" placeholder="例: 100*5+50" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                            <div class="text-xs text-gray-500 mt-1">每人: <span id="fundCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">或直接輸入每人金額</label>
                            <input type="number" id="fundAmount" placeholder="每人金額" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">幣別</label>
                            <select id="fundCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="THB">泰銖 (THB)</option>
                                <option value="TWD">台幣 (TWD)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3 p-3 bg-gray-50 rounded text-sm" id="fundPreview">
                        <strong>預覽:</strong> 每人繳交 0 THB，總計收入 0 THB
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button onclick="addPublicFund()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 btn">收取公費</button>
                        <button onclick="toggleAddFunds()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">取消</button>
                    </div>
                </div>
            </div>

            <!-- 支出管理 -->
            <div class="mb-8 bg-blue-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-blue-600" viewBox="0 0 24 24">
                            <path d="M12 1v22"></path>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        <h2 class="text-2xl font-bold text-blue-800">支出記錄</h2>
                    </div>
                    <button onclick="toggleAddExpense()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center gap-2 btn" id="addExpenseBtn">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 5v14"></path>
                            <path d="M5 12h14"></path>
                        </svg>
                        新增支出
                    </button>
                </div>

                <div class="bg-white p-4 rounded-lg border border-blue-200 mb-4 hidden" id="addExpenseForm">
                    <h3 class="font-semibold text-blue-800 mb-3" id="expenseFormTitle">新增支出</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">支出描述</label>
                            <input type="text" id="expenseDesc" placeholder="例: 晚餐費用" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">日期</label>
                            <input type="date" id="expenseDate" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">金額計算</label>
                            <input type="text" id="expenseCalc" placeholder="例: 200*3+150" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="text-xs text-gray-500 mt-1">計算結果: <span id="expenseCalcResult">0</span></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">或直接輸入金額</label>
                            <input type="number" id="expenseAmount" placeholder="金額" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">幣別</label>
                            <select id="expenseCurrency" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="THB">泰銖 (THB)</option>
                                <option value="TWD">台幣 (TWD)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">付款方式</label>
                            <select id="expensePaidBy" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="public">公費支付</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">使用人員</label>
                            <div class="flex flex-wrap gap-2" id="usedByButtons">
                                <!-- 動態生成 -->
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="addExpense()" class="px-4 py-2 bg-blue-500 text-white rounded btn" id="expenseSubmitBtn">新增支出</button>
                        <button onclick="cancelExpenseEdit()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 btn">取消</button>
                    </div>
                </div>

                <!-- 支出列表 -->
                <div class="space-y-3" id="expensesList">
                    <!-- 動態生成 -->
                </div>
            </div>

            <!-- 最終結算 -->
            <div class="bg-purple-50 rounded-lg p-6 card">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <svg class="icon text-purple-600" viewBox="0 0 24 24">
                            <rect x="4" y="4" width="16" height="16" rx="2"></rect>
                            <rect x="9" y="9" width="1" height="1"></rect>
                            <rect x="14" y="9" width="1" height="1"></rect>
                            <rect x="9" y="14" width="1" height="1"></rect>
                            <rect x="14" y="14" width="1" height="1"></rect>
                        </svg>
                        <h2 class="text-2xl font-bold text-purple-800">最終結算</h2>
                    </div>
                    <button onclick="toggleSettlement()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 btn" id="settlementBtn">顯示 結算</button>
                </div>

                <div class="space-y-4 hidden" id="settlementContent">
                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">最終結算明細 (已含已繳公費)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="settlementGrid">
                            <!-- 動態生成 -->
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border border-purple-200">
                        <h3 class="font-bold text-lg mb-3 text-purple-800">說明</h3>
                        <div class="text-sm text-gray-600 space-y-2">
                            <p>• <strong>💰 綠色數字</strong>：表示此人應收回的金額（已付超過應付）</p>
                            <p>• <strong>💸 紅色數字</strong>：表示此人需補繳的金額（應付超過已付）</p>
                            <p>• 計算已包含每人已繳交的公費金額</p>
                            <p>• 匯率: 1 TWD = 1.1 THB</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let friends = ['', '', '', '', '', ''];
        let publicFunds = { TWD: 0, THB: 0 };
        let publicContributions = { TWD: 0, THB: 0 };
        let expenses = [];
        let editingExpenseId = null;
        let usedBySelection = [];
        const exchangeRate = 1.1;

        // 儲存資料到本地存儲
        function saveData() {
            const data = {
                friends,
                publicFunds,
                publicContributions,
                expenses,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('chiangMaiExpenseTracker', JSON.stringify(data));
            
            // 顯示儲存提示
            showSaveNotification();
        }

        // 載入資料從本地存儲
        function loadData() {
            const savedData = localStorage.getItem('chiangMaiExpenseTracker');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    friends = data.friends || ['', '', '', '', '', ''];
                    publicFunds = data.publicFunds || { TWD: 0, THB: 0 };
                    publicContributions = data.publicContributions || { TWD: 0, THB: 0 };
                    expenses = data.expenses || [];
                    
                    console.log('已載入儲存的資料，最後更新時間:', data.lastUpdated);
                    return true;
                } catch (e) {
                    console.error('載入資料失敗:', e);
                    return false;
                }
            }
            return false;
        }

        // 清除所有資料
        function clearAllData() {
            if (confirm('確定要清除所有資料嗎？此操作無法復原！')) {
                localStorage.removeItem('chiangMaiExpenseTracker');
                // 重置所有變數
                friends = ['', '', '', '', '', ''];
                publicFunds = { TWD: 0, THB: 0 };
                publicContributions = { TWD: 0, THB: 0 };
                expenses = [];
                editingExpenseId = null;
                usedBySelection = [];
                
                // 重新渲染頁面
                renderFriends();
                updateDisplay();
                renderExpenses();
                
                alert('所有資料已清除！');
            }
        }

        // 匯出資料
        function exportData() {
            const data = {
                friends,
                publicFunds,
                publicContributions,
                expenses,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `清邁放空團記帳_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 顯示儲存通知
        function showSaveNotification() {
            // 移除現有的通知
            const existingNotification = document.getElementById('saveNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // 創建新通知
            const notification = document.createElement('div');
            notification.id = 'saveNotification';
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.innerHTML = '💾 資料已自動儲存';
            document.body.appendChild(notification);
            
            // 3秒後移除通知
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 2000);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 先載入儲存的資料
            const hasData = loadData();
            
            renderFriends();
            updateExpenseDate();
            updateDisplay();
            renderExpenses();
            setupEventListeners();
            
            if (hasData) {
                console.log('已載入先前的資料');
            }
        });

        // 設定事件監聽器
        function setupEventListeners() {
            // 公費計算輸入框
            const fundCalc = document.getElementById('fundCalc');
            const fundAmount = document.getElementById('fundAmount');
            const fundCurrency = document.getElementById('fundCurrency');
            
            if (fundCalc) {
                fundCalc.addEventListener('input', updateFundCalc);
            }
            if (fundAmount) {
                fundAmount.addEventListener('input', updateFundPreview);
            }
            if (fundCurrency) {
                fundCurrency.addEventListener('change', updateFundPreview);
            }
            
            // 支出計算輸入框
            const expenseCalc = document.getElementById('expenseCalc');
            if (expenseCalc) {
                expenseCalc.addEventListener('input', updateExpenseCalc);
            }
        }

        // 計算函數
        function calculateAmount(input) {
            try {
                return Function('"use strict"; return (' + input + ')')() || 0;
            } catch (e) {
                return 0;
            }
        }

        // 獲取有效朋友
        function getValidFriends() {
            return friends.filter(f => f.trim() !== '');
        }

        // 渲染朋友列表
        function renderFriends() {
            const grid = document.getElementById('friendsGrid');
            grid.innerHTML = '';
            
            friends.forEach((friend, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                
                const span = document.createElement('span');
                span.className = 'text-sm text-gray-600 w-8';
                span.textContent = `#${index + 1}`;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = friend;
                input.placeholder = `團員 ${index + 1} 姓名`;
                input.className = 'flex-1 p-3 border border-orange-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500';
                input.addEventListener('input', function() {
                    updateFriend(index, this.value);
                });
                input.addEventListener('blur', function() {
                    updateFriend(index, this.value);
                });
                
                div.appendChild(span);
                div.appendChild(input);
                grid.appendChild(div);
            });
            
            updateFriendsStatus();
            updateExpenseOptions();
        }

        // 更新朋友
        function updateFriend(index, value) {
            friends[index] = value;
            updateFriendsStatus();
            updateExpenseOptions();
            saveData(); // 自動儲存
        }

        // 更新朋友狀態
        function updateFriendsStatus() {
            const validFriends = getValidFriends();
            document.getElementById('friendsStatus').innerHTML = 
                `已填寫團員: ${validFriends.length}/6 人${validFriends.length > 0 ? ` (${validFriends.join(', ')})` : ''}`;
        }

        // 更新支出選項
        function updateExpenseOptions() {
            const validFriends = getValidFriends();
            const paidBySelect = document.getElementById('expensePaidBy');
            const usedByDiv = document.getElementById('usedByButtons');
            
            // 更新付款方式
            paidBySelect.innerHTML = '<option value="public">公費支付</option>';
            validFriends.forEach(friend => {
                paidBySelect.innerHTML += `<option value="${friend}">${friend} 個人支付</option>`;
            });
            
            // 更新使用人員
            usedByDiv.innerHTML = '';
            validFriends.forEach(friend => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `px-3 py-1 rounded-full text-sm ${
                    usedBySelection.includes(friend) 
                        ? 'bg-blue-500 text-white' 
                        : 'bg-gray-200 text-gray-700'
                }`;
                button.textContent = friend;
                button.onclick = () => toggleUsedBy(friend);
                usedByDiv.appendChild(button);
            });
            
            document.getElementById('fundsPersonCount').textContent = validFriends.length;
            
            // 更新按鈕狀態
            const hasValidFriends = validFriends.length > 0;
            document.getElementById('addFundsBtn').disabled = !hasValidFriends;
            document.getElementById('addExpenseBtn').disabled = !hasValidFriends;
        }

        // 切換使用人員
        function toggleUsedBy(friend) {
            const index = usedBySelection.indexOf(friend);
            if (index > -1) {
                usedBySelection.splice(index, 1);
            } else {
                usedBySelection.push(friend);
            }
            updateExpenseOptions();
        }

        // 更新公費計算
        function updateFundCalc() {
            const input = document.getElementById('fundCalc').value;
            const result = calculateAmount(input);
            document.getElementById('fundCalcResult').textContent = result;
            updateFundPreview();
        }

        // 更新公費預覽
        function updateFundPreview() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
            const totalAmount = perPersonAmount * validFriends.length;
            
            document.getElementById('fundPreview').innerHTML = 
                `<strong>預覽:</strong> 每人繳交 ${perPersonAmount} ${currency}，總計收入 ${totalAmount} ${currency}`;
        }

        // 更新支出計算
        function updateExpenseCalc() {
            const input = document.getElementById('expenseCalc').value;
            const result = calculateAmount(input);
            document.getElementById('expenseCalcResult').textContent = result;
        }

        // 更新支出日期
        function updateExpenseDate() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }

        // 切換公費表單
        function toggleAddFunds() {
            const form = document.getElementById('addFundsForm');
            const isHidden = form.classList.contains('hidden');
            
            if (isHidden) {
                form.classList.remove('hidden');
                updateFundPreview();
                // 重新綁定事件監聽器
                setTimeout(setupEventListeners, 100);
            } else {
                form.classList.add('hidden');
                // 清空表單
                document.getElementById('fundCalc').value = '';
                document.getElementById('fundAmount').value = '';
                document.getElementById('fundCurrency').value = 'THB';
            }
        }

        // 新增公費
        function addPublicFund() {
            const calcInput = document.getElementById('fundCalc').value;
            const directAmount = document.getElementById('fundAmount').value;
            const currency = document.getElementById('fundCurrency').value;
            
            const perPersonAmount = calcInput ? calculateAmount(calcInput) : (parseFloat(directAmount) || 0);
            const validFriends = getValidFriends();
